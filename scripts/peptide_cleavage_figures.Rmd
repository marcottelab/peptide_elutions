--
title: "Peptide_cleavage_data_analysis"
output: html_document
---


This is analysis and data to support 
"Alternative proteoforms and proteoform-dependent assemblies in humans and plants"



# Load libraries and functions and set style
```{r libraries}
library(tidyverse)
library(cowplot)
library(broom)
library(patchwork)
library(ggridges)
library(seqinr)
library(future)
library(furrr)
library(plotly)
library(shiny)

source("scripts/fasta_utils.R")
source("scripts/theme_utils.R")
source("scripts/saved_ggplots.R")
source("scripts/simple_AdaptGauss.R")
theme_set(theme_cowplot_consistent_text(font_size = 8))
palette <- rep(c("#0072B2","#E69F00","#009E24","#FF0000", "#979797","#5530AA"), 8)
```



# Load and format proteomics data

### Load peptide elution data
```{r}

# Get those arabidopsis IEX's
data_path <- "data"
short_tidy_filenames <- dir(data_path, pattern = ".*.pepcount.annot.short.tidy$") # Get filenames of data


# Data format description

#Peptide,ExperimentID,experiment_order,experiment_name,spec,ProteinID,Start,End,status,ID,seqlen,FractionID,pepcount,FractionOrder,totfracts
#MDMEMK,soybn_Soy_SECwithStandards,20,SOYBN_SEC2,soybn,tr|I1JP35|I1JP35_SOYBN,1,6,protein_unique,KOG4249,419,SoySEC_standards_03a_03142018,2,2,70

# Minimum necessary columns are Peptide, ExperimentID, ProteinID, Start, End, FractionOrder, pepcount
# Start,End give location of peptide, indexed from 1
# FractionOrder (numeric) is which fraction where the peptide was seen

short_tidy_filenames


short_tidy <- tibble(filename = short_tidy_filenames) %>%
               mutate(file_contents = map(filename, ~ read_csv(file.path(data_path, .)))) %>%
               unnest(cols = c(file_contents)) %>%
  as_tibble() %>%
  rename(totfracs = totfracts)

# Only take proteins with at least 10 unique peptides observed across experiments
numpeps_filter <- short_tidy %>%
  select(ProteinID, Peptide) %>%
  unique() %>%
  dplyr::count(ProteinID) %>% #seqinr can overwrite count
  filter(n >= 10) %>%
  select(ProteinID)

short_tidy %>% write_csv("data/short_tidy.csv")
short_tidy <- read_csv("data/short_tidy.csv")

numpeps_filter %>% write_csv("data/numpeps_filter_10.csv")
numpeps_filter <- read_csv("data/numpeps_filter_10.csv")


short_tidy_filt <- short_tidy %>%
   filter(ProteinID %in% numpeps_filter$ProteinID)

```


### Get only protein unique peptides
```{r}

short_tidy_unique <- short_tidy_filt %>%
  filter(status == "protein_unique") %>% select(-filename, -status)
short_tidy_unique %>% write_csv("data_files/short_tidy_unique.csv")

```






# Load accessory files


### Load proteome sequences and annotations
```{r}


human_proteome <- read_fasta('/project/cmcwhite/data/peptide_elutions/protein_identification/proteomes/human_uniprot-proteome_human_reviewed.fasta')

arath_proteome <- read_fasta('/project/cmcwhite/data/peptide_elutions/protein_identification/proteomes/arath_uniprot-proteome_UP000006548.fasta')

chlre_proteome <- read_fasta('/project/cmcwhite/data/peptide_elutions/protein_identification/proteomes/chlre_uniprot-proteome_UP000006906.fasta')



human_proteome %>% write_csv("data_files/human_proteome.csv")
arath_proteome %>% write_csv("data_files/arath_proteome.csv")
chlre_proteome %>% write_csv("data_files/chlre_proteome.csv")

human_proteome <- read_csv("data_files/human_proteome.csv")
arath_proteome <- read_csv("data_files/arath_proteome.csv")
chlre_proteome <- read_csv("data_files/chlre_proteome.csv")

get_meta <- function(proteome){
  meta <- proteome %>%
  select(ID, Sequence) %>%
   separate(ID, into = c(NA, 'Entry', 'Entry_name'), sep = "[|]") %>%
  mutate(seqlen = str_length(Sequence)) %>%
    
  select(-Sequence)
  return(meta)
  
}
human_meta <- get_meta(human_proteome)
arath_meta <- get_meta(arath_proteome)
chlre_meta <- get_meta(chlre_proteome)


meta <- bind_rows(
  human_meta,
  arath_meta,
  chlre_meta
) 

```


### Domain coordinate annotations

```{r}

domains_human <- read_delim("/project/cmcwhite/data/exons/data/human_reviewed_accs_interpro.txt", delim ="\t", col_names = c("Entry", "Interpro_ID", "Annotation",  "Source_ID", "ProtBegin", "ProtEnd"))
domains_pfam_human <- domains_human %>% filter(grepl("^PF", Source_ID))

domains_arath <- read_delim("/project/cmcwhite/data/exons/data/arath_accs_interpro.txt", delim ="\t", col_names = c("Entry", "Interpro_ID", "Annotation",  "Source_ID", "ProtBegin", "ProtEnd"))
domains_pfam_arath <- domains_arath %>% filter(grepl("^PF", Source_ID))

domains_chlre <- read_delim("/project/cmcwhite/data/exons/data/chlre_accs_interpro.txt", delim ="\t", col_names = c("Entry", "Interpro_ID", "Annotation",  "Source_ID", "ProtBegin", "ProtEnd"))
domains_pfam_chlre <- domains_chlre %>% filter(grepl("^PF", Source_ID))

domains_pfam <- bind_rows(
  domains_pfam_human,
  domains_pfam_arath,
  domains_pfam_chlre
)


```


### Orthologies for consolidation related proteins across species
```{r}
human_orthology <- read_tsv("protein_identification/eggnog_mapping/human_hmmer_euNOG.mapping")
arath_orthology <- read_tsv("protein_identification/eggnog_mapping/arath_hmmer_euNOG.mapping")
chlre_orthology <- read_tsv("protein_identification/eggnog_mapping/chlre_hmmer_euNOG.mapping")


orthologies <-
  bind_rows(human_orthology,
            arath_orthology,
            chlre_orthology)
```


### For comparing fragments to known isoforms
```{r}
human_w_isoform <- read_fasta("annotation_files/uniprot_human_reviewed_isoforms.fasta")

human_w_isoform %>%
   separate(ID, into = c("repo", "Entry_tmp", "Entry_name"), remove = FALSE, sep = "[|]") %>%
  separate(Entry_tmp, into = c("Entry", "isoform_num"), sep = "-") %>%
  group_by(Entry) %>%
     summarize(n = n()) %>%
  ungroup %>%
  mutate(isoform_status = case_when(n == 1 ~ "no_isoform",
                                    n >1 ~ "isoforms")) %>%
  group_by(isoform_status) %>%  
      summarise(n = n())

# Proteins with isoform
#10535/(9817 + 10535)
```

# Load domain/disorder coordinate annotations
### Downloaded from https://mobidb.org/ browse
```{r}

mobidb_human <- read_delim("/project/cmcwhite/data/exons/data/mobidb_human.txt", delim ="\t") 
mobidb_arath <- read_delim("/project/cmcwhite/data/exons/data/mobidb_arath.txt", delim ="\t") 
mobidb_chlre <- read_delim("/project/cmcwhite/data/exons/data/mobidb_chlre.txt", delim ="\t") 

domains_dis <- bind_rows(
  mobidb_chlre,
  mobidb_human,
  mobidb_arath
) %>%
  filter(feature %in%  c("prediction-disorder-mobidb_lite", "prediction-transmembrane-uniprot")) %>%
  separate_rows(`start..end`, sep = ",") %>%
  separate(`start..end`, into = c("ProtBegin", "ProtEnd"), sep = "[.][.]") %>%
  mutate(ProtBegin = as.integer(ProtBegin)) %>%
  mutate(ProtEnd = as.integer(ProtEnd)) %>%
  rename(Entry = acc) %>%
  select(Entry, ProtBegin, ProtEnd, feature) %>% 
  mutate(set = case_when(feature == "prediction-disorder-mobidb_lite"~ "Disordered",
                              feature == "prediction-transmembrane-uniprot" ~ "Transmembrane")) %>%
  select(-feature)
```

Make annotation plots
```{r}
domains_dis

domains_dis_formatted <- domains_dis%>%
  select(Entry, ProtBegin,ProtEnd, set) %>%
  mutate(Annotation ="Disordered") %>%
  
  mutate(ymin = case_when(set == "Disordered" ~ 0.8,
                          set == "Transmembrane" ~ 1)) %>%
   mutate(ymax = case_when(set == "Disordered" ~ 1,
                          set == "Transmembrane" ~ 1.4))

domains_pfam_formatted <- domains_pfam %>%
  select(Entry, ProtBegin,ProtEnd, Annotation) %>%
  mutate(ymin = 0.1, ymax = 0.8) %>%
  mutate(set = 'Domains')

domaindis_setup <- 
  bind_rows(
    domains_pfam_formatted,
    domains_dis_formatted
    
  ) %>%
  full_join(meta) %>%
  mutate(set = fct_relevel(set, c("Domains", "Disordered", "Transmembrane"))) %>%
  filter(!is.na(Entry_name)) # There are some other proteins brought in with pfam

domaindis_setup %>%
  write_tsv("data_files/domaindis_setup.txt")

domaindis_setup
domaindis_setup %>%
 # filter(Entry_name == "RK2_CHLRE") %>%
 filter(Entry_name == "MER34_HUMAN") %>%
  ggplot() +
  geom_rect(fill = "grey90", aes(xmin = 0, xmax = seqlen, ymin = 0.1, ymax = 0.8)) +
  geom_rect(aes(xmin = ProtBegin, xmax = ProtEnd, ymin = ymin, ymax = ymax, fill = set)) +
  theme(axis.line.x = element_blank(),
        axis.text.x = element_blank(),
        axis.ticks.x= element_blank(),
        axis.line.y = element_blank(),
        axis.title.y = element_blank()) +
  coord_flip() +
  scale_fill_manual(values = c("orange", "cadetblue4", "purple")) +
  scale_y_continuous(limits = c(0,15), expand = c(0,0)) +
  scale_x_reverse(expand = c(0,0)) +
  #scale_y_continuous()
  geom_text_repel(y = 1, ylim = c(1,15), aes(x = ProtBegin, label = Annotation)) +
  theme(legend.position = "none") 
  
  

```



```{r}

domaindis_setup <- read_tsv("data_files/domaindis_setup.txt")
  domain_dis_plot <- domaindis_setup %>%
  filter(Entry_name == "WDR44_HUMAN") %>%
    mutate(label = str_replace(Entry_name, "_", "\n")) %>%
    mutate(label = str_replace(label, "A0A2K3", "c")) %>%
  
  ggplot() +
  geom_rect(fill = "grey90", aes(xmin = 0, xmax = seqlen, ymin = 0.1, ymax = 0.8)) +
  geom_rect(aes(xmin = ProtBegin, xmax = ProtEnd, ymin = ymin, ymax = ymax, fill = set)) +
  theme(axis.line.y = element_blank(),
        axis.text.y = element_blank(),
        axis.ticks.y= element_blank(),
        axis.line.x = element_blank(),
        axis.title.x = element_blank()) +
  scale_fill_manual(values = c("orange", "cadetblue4")) +
  scale_y_continuous(limits = c(0,2), expand = c(0,0)) +
  #scale_x_reverse(expand = c(0,0)) +
  geom_text_repel(alpha = 0.7, y = 1, ylim = c(1,2), size = 2.5, aes(x = ProtBegin, label = Annotation)) +
  theme(legend.position = "none") +
    facet_wrap(~label, ncol = 1, strip.position = "left")

domain_dis_plot



```




# Descriptive files
### Make descriptive files
```{r}
total_exps <-  short_tidy_filt %>%
  select(experiment_name ) %>%
  unique 

fraction_names  <- short_tidy_filt %>%
  select(experiment_name, FractionID, FractionOrder) %>%
  unique 

fraction_names %>%
  write_csv("annotation_files/fraction_names.csv")


total_fractions <- fraction_names %>%
  group_by(experiment_name) %>%
     summarize(totfracs = max(FractionID))
     
total_fractions %>%
  write_csv("annotation_files/total_fractions.csv")


short_tidy_filt %>%
    filter(spec != "soybn") %>%
  summarize(npeps = sum(pepcount))

short_tidy_filt %>%
    filter(spec != "soybn") %>%
  select(ProteinID) %>%
  unique() %>%
  nrow()
```


#### Make small postage stamp plots for visual screening
Step one for picking out positives
```{r}

plan(multiprocess)


make_filename <- function(data, device){
  orthoid <- data$ID[[1]]
  protid <- str_replace_all(data$ProteinID[[1]], "[|]", "_") 
  
  filename <-  paste0(orthoid, "-", protid, ".", device)
  
  return(filename)
}

plotter_wrapper <- function(data, device){
  plt1 <- pep_heatmap_fxn(data)
  plt2 <- pepcov_fxn(data, pubtheme = FALSE)

  plt <- plot_grid(plt1, plt2, align = "vh", axis = "x")
  filename <- make_filename(data, device)
  print(filename)
  ggsave(filename, plt, device = device,  width = 7, height = 4, units = "in")
  return(data.frame(status = "SUCCESS"))
}


safe_plotter <- possibly(plotter_wrapper, otherwise = data.frame(status = "FAILED"))

short_tidy_unique %>% 
  arrange(Start, End) %>%
    filter(ProteinID == "sp|A6NCN2|KR87P_HUMAN") %>%
  split(.$ProteinID) %>%
  future_map_dfr(~plotter_wrapper(.x, "png"), .id = "ProteinID.exp", .progress = TRUE) %>%
  #future_map_dfr(~safe_plotter(.x, "png"), .id = "ProteinID.exp", .progress = TRUE) %>%
  data.frame() -> command_out
```

# Make positive/negative sets



```{r}

# Positive and negative labels were for figuring score. 
# Positives were proteins with interesting elution patterns, negatives were random

set.seed(42)

# Positives were hand selected
positives <- read_csv("data_files/positive_filenames.txt", col_names = "filename") %>% 
  separate(filename, into =c("spec", "experiment_type", "ProteinID"), sep = "_", extra= "merge") %>%
  mutate(ProteinID = str_replace(ProteinID, '.tiff', '')) %>%
  
  mutate(experiment_name = paste0(spec, "_", experiment_type))%>%
 # separate(ProteinID, into = c(NA,"Entry", NA,  NA, NA)) %>%
  mutate(ProteinID = str_replace(ProteinID, "_", "|")) %>%
    mutate(ProteinID = str_replace(ProteinID, "_", "|")) %>%

  select(ProteinID, experiment_name) %>%
    mutate(label = "pos")%>%
  filter(!grepl("HEKU", experiment_name)) %>%
  filter(!grepl("MAIZE_SEC", experiment_name)) %>%
  filter(!grepl("HEKR_IEX", experiment_name)) 


set.seed(43)
positives_rand <- positives %>% 
  sample_n(nrow(positives), replace = F)

positives_train <- positives_rand %>%
   head(as.integer(0.5*nrow(positives_rand))) %>%
  mutate(set = "train")

positives_validate <- positives_rand %>%
  anti_join(positives_train) %>%
  mutate(set = "val")

#positives_train %>%
#  write_csv("data_files/positive_train.csv")
#positives_validate %>%
#  write_csv("data_files/positive_validate.csv")

# Make sure proteins I've been calibrating with are in training set. 
# Expand to more proteins
positives_train %>% filter(grepl("TSS", ProteinID))
positives_train %>% filter(grepl("VILI4", ProteinID))


negatives <- short_tidy  %>%
    
    filter(!ProteinID %in% positives$ProteinID) %>%
  sample_n(1000, replace = F) %>%
  select(ProteinID, experiment_name) %>% unique %>%
  mutate(label = "neg") %>%
    filter(!(ProteinID %in% positives$ProteinID)) 


negatives_train <- negatives %>%
   head(500) %>%
   mutate(set ="train")

negatives_validate <- negatives  %>%
  tail(500) %>%
  mutate(set = "val")


#negatives_train %>%
#  write_csv("data_files/negative_train.csv")
#negatives_validate %>%
#  write_csv("data_files/negative_validate.csv")


labels <- bind_rows(
  positives_train,
  positives_validate,
  negatives_train,
  negatives_validate
)


labels %>% write_csv("labels.csv")
labels <- read_csv("labels.csv")




```

### Get smaller dataset of just labeled proteins
```{r}

short_tidy_unique_labeled <- short_tidy_unique %>% 
        filter(ProteinID %in% labels$ProteinID) 

```


VILI4_ARATH, TSS_ARATH were used to calibrate gaussian git and downstream to log2fold change

RFA1_HUMAN = has an N-terminal

# Detection of proteoforms
### Start proteoform detection process

Modified AdaptGauss to fit up to 5 peaks, and run for more iterations (finds better fit)

Returns lowest RMS peak fitting

Don't penalize more peaks, since it's legitimate to have one peak or multiple peaks 

Use the output of 

Then move from N->C to look for max difference between coverage in Nterm vs Cterm for each peak

variation 1 -> N

# Part 1: AdaptGauss
##### Testing AdaptGauss prior to run on full set
For one at a time
This is for testing out modifications to the AdaptGauss
```{r}

#testing AdaptGauss process on single protein

# Filter dataset to just one protein in one experiment
tester <- short_tidy_unique_peaks %>% 
   #filter(grepl("VILI4_ARATH", ProteinID)) %>% 
   #filter(experiment_name == "ARATH_IEX1")
   #filter(ProteinID == "sp|P78347|GTF2I_HUMAN") %>%
   #filter(experimentiname== "HEKR_IEX2") %>%
   #filter(ProteinID == "sp|P45974|UBP5_HUMAN") %>%
   #filter(experiment_name== "HEMO_IEX1") 
   filter(ProteinID == "sp|Q13576|IQGA2_HUMAN") %>%
   filter(experiment_name== "HEK_SEC1") 

# See output of test
possibly_get_boundaries(tester) %>% 
  left_join(select(tester, -peak), by = "FractionID") %>%
   ggplot(aes( color = as.factor(peak), alpha = pepcount)) +
       geom_point(aes(x = Start, y = FractionID)) +
   facet_wrap(~experiment_name, scales = "free_y")

```

Peak fitting
```{r}
# About an hour
plan("multisession")

peaks <-  
  short_tidy_unique %>%

  filter(pepcount > 0) %>%
  
  #filter(experiment_name == "ARATH_IEX1") %>%
  #filter(grepl("VILI4_ARATH", ProteinID)) %>%
  split(list(.$ProteinID, .$experiment_name)) %>%
     future_map_dfr(~possibly_get_boundaries(.x), .id = "id", .progress = TRUE) %>% 
  separate(id, into = c("ProteinID", "experiment_name"), sep = "[.]")
```

```{r}

# View peaks on protein
short_tidy_unique %>% 
  inner_join(peaks)  %>%
    #filter(grepl("VILI4_ARATH", ProteinID)) %>% 
  
   filter(ProteinID == "sp|P78347|GTF2I_HUMAN") %>%
  ggplot(aes( color = as.factor(peak), alpha = pepcount)) +
       geom_point(aes(x = Start, y = FractionID)) +
  facet_wrap(~experiment_name, scales = "free_y")



peaks %>% write_csv("/project/cmcwhite/data/peptide_elutions/peaks_rms.csv")
peaks <- read_csv("/project/cmcwhite/data/peptide_elutions/peaks_rms.csv")


# Only dataset of +/- labeled proteins for testing
#short_tidy_unique_labeled_peaks <-  short_tidy_unique_labeled %>%
#     left_join(peaks,  by = c("ProteinID","experiment_name", "FractionOrder"))


# Full dataset
short_tidy_unique_peaks <-  short_tidy_unique %>%
     left_join(peaks,  by = c("ProteinID","experiment_name", "FractionOrder"))

```


### Checking peak fitting in proteins-of-interest
```{r}
  short_tidy_unique_peaks %>% 
  
   
  filter(grepl("NASP", ProteinID)) %>%

  filter(experiment_name == "HEK_SEC1") %>%

  ggplot(aes( color = as.factor(peak), alpha = pepcount)) +
       geom_point(aes(x = Start, y = FractionID)) +
  facet_wrap(~experiment_name, scales = "free_y")


short_tidy_unique_peaks %>% 
    filter(grepl("RH38_ARATH", ProteinID)) %>% 
  ggplot(aes( color = as.factor(peak), alpha = pepcount)) +
       geom_point(aes(x = Start, y = FractionOrder)) +
  facet_wrap(~experiment_name, scales = "free_y")

short_tidy_unique_peaks %>% 
    filter(grepl("MTV1_ARATH", ProteinID)) %>% 
  ggplot(aes( color = as.factor(peak), alpha = pepcount)) +
       geom_point(aes(x = Start, y = FractionID)) +
  facet_wrap(~experiment_name, scales = "free_y")



```







First classify by eye
Then classify by fit
Then classify fit peaks manually

This is applied to peptides under each fitted peak, to get maximal terminal skew.


### Filtering peaks by # of peptides
```{r}
numpeps_sel <- numpeps %>% filter(numpeps >= 9)

# Remove benzonzase experiments
# Expand peptides with observable peptides
short_tidy_unique_peaks_expanded <- short_tidy_unique_peaks %>%
  semi_join(numpeps_sel) %>% # Get rid of proteins with <9 unique peptides per an experiment
     
  select(-ExperimentID, -spec, -ID, -experiment_order) %>% # Unused columns
  select(-FractionID, -pepcount) %>% unique %>%
   mutate(pepid = paste0(Start, "-", End)) %>%
   mutate(presence = "observed") %>%
  
    group_by(ProteinID) %>%
     complete(nesting(pepid, Peptide), nesting(experiment_name, peak)) %>%
   ungroup %>%
     separate(pepid, into = c("Start", "End"), sep = "-", convert = TRUE, remove = FALSE) %>% # get start and end for filled in peptides
    mutate(presence = replace_na(presence, "missing")) # Filled in peptides get zero presence

# Get peaks that have at least 7 unique peptides
enough_cov_peaks <- short_tidy_unique_peaks %>%
   filter(!is.na(peak)) %>%
    group_by(ProteinID, peak, experiment_name) %>%
    mutate(n = n()) %>%
  ungroup %>%
  filter(n >= 7) %>%
  select(-n)

short_tidy_unique_peaks_expanded_fragments  <- short_tidy_unique_peaks_expanded %>%
  filter(!is.na(peak)) %>%
  semi_join(enough_cov_peaks, by = c("ProteinID", "peak", "experiment_name"))
  
short_tidy_unique_peaks_expanded_fragments  %>%
  write_csv("data/short_tidy_unique_peaks_expanded_fragments.csv")

```

# Part 2: Calculate terminal bias
Calculation observable N -> C
                           N - > Observable C
### Calibrating terminal scores
```{r}
oneexp <- short_tidy_unique_fragments %>%
  filter(grepl("VILI4_ARATH", ProteinID)) %>% 
  filter(experiment_name == "ARATH_SEC1") %>%
  filter(peak ==4) %>%
  arrange(Start, End)

get_terminal_ranges <- function(oneexp){
    firstobs <- oneexp %>%
       filter(presence == "observed") %>%
       filter(Start == min(Start)) %>% pull(Start) %>% head(1)
    lastobs <- oneexp %>%
       filter(presence == "observed") %>%
       filter(Start == max(Start)) %>% pull(Start) %>% head(1)
          
    # observed = in this experiment, possible = seen at all across experiments / detectable
    # Look from first possible peptide to last observed peptide
    missing_n <- oneexp %>%
       filter(Start <= lastobs)
    # Look from first observed peptide to last possible peptide
    missing_c <- oneexp %>%
       filter(Start >= firstobs)
    return(list(missing_n$Start, missing_c$Start))
}

get_missing_obs_counts <- function(start, oneexp){

    df <-oneexp %>%
     group_by(ProteinID, peak, experiment_name) %>%
        mutate(fragment_end = case_when(Start < {{ start }}  ~ "nterm",
                                 Start >= {{ start }} ~ "cterm")
               ) %>% ungroup %>%
    group_by(ProteinID, peak, experiment_name, fragment_end) %>%
        dplyr::count(presence) %>% # Overwritted by seqinr
      ungroup %>%
     mutate(n= n + 1) %>%
     pivot_wider(names_from = c(presence, fragment_end), values_from = n, values_fill = 1) %>%
      mutate(bp_start = {{ start }})
    return(df)
}


get_bps <- function(oneexp){
    # Terminal bias calculation
    missing <- get_terminal_ranges(oneexp)
    missing_n <- missing[[1]]
    missing_c <- missing[[2]]

    # C terminal fragments are missing n termini
    c_fragments <- map_dfr(missing_n, ~get_missing_obs_counts(., oneexp)) %>%
      mutate(terminal = "cterm_extension")
    # N terminal fragments are missing c termini
    n_fragments <- map_dfr(missing_c, ~get_missing_obs_counts(., oneexp)) %>%
      mutate(terminal = "nterm_extension")


    fragments <- bind_rows(n_fragments, c_fragments) %>%
            mutate_at(vars(contains("term")), replace_na, 1) 
    
  
    fragments <- fragments %>%
      
      mutate(       ratio_cterm = observed_cterm/(observed_cterm + missing_cterm),
                    ratio_nterm = observed_nterm/(observed_nterm + missing_nterm)
                    ) %>% 
      #select(-breakpointleft_pepid, -breakpointright_pepid) %>%
       mutate(fc = ratio_nterm/ratio_cterm) %>%
       mutate(log2fc = log2(fc)) %>%
       mutate(abs_log2fc = abs(log2fc))

  return(fragments)
  
}


possibly_get_bps <- possibly(get_bps, otherwise = data.frame())

bps <- short_tidy_unique_peaks_expanded_fragments %>%
  #filter(grepl("VILI4_ARATH", ProteinID)) %>%
  #filter(experiment_name == "ARATH_SEC1") %>%
  #filter(grepl("Y4554_ARATH", ProteinID)) %>% 
  #filter(experiment_name == "ARATH_IEX1") %>%

  
  arrange(Start, End)%>%
  split(list(.$ProteinID, .$experiment_name, .$peak)) %>%
  future_map_dfr(~possibly_get_bps(.))


bps %>% write_csv("scanning_breakpoints_all.csv")

bps <- read_csv("scanning_breakpoints_all.csv")


```

### Calculate terminal bias for each peak
```{r}

# Get which peptides were observed in each peak
obs_key <- short_tidy_unique_peaks_expanded_fragments %>%
  select(ProteinID, experiment_name, peak, Start, presence) %>% unique

# Need to get either next observed peptide past peak for C-terminal fragment 
# or previous observed pepide prior to peak for N-terminal fragment
bps_identified <- bps %>%
  group_by(ProteinID, experiment_name, peak) %>%
      filter(abs_log2fc == max(abs_log2fc))%>% data.frame() %>%

  left_join(obs_key, by = c("ProteinID", "experiment_name", "peak")) %>%
     arrange(Start) %>%
  filter(presence == "observed") %>%
  mutate(diff = Start - bp_start) %>% 
  mutate(remove_flag = case_when(log2fc > 0 & diff >0  ~ TRUE, # Only look to left of N-term frag
                                       
                           log2fc < 0 & diff < 0 ~ TRUE,
                           TRUE ~ FALSE
                            )) %>% #Only look toward C-terminal for C-term frag
  filter(remove_flag != TRUE) %>%
  filter(diff !=0) %>% # Always offset by 1 
  arrange(diff ) %>%
  group_by(ProteinID, experiment_name, peak) %>%
    mutate(terminal = case_when(log2fc > 0 ~ "nterm",
                              log2fc < 0 ~ "cterm")) %>%
   mutate(actual_terminal_peptide = case_when(log2fc > 0 & diff == max(diff) ~ Start,
                                       
                                              log2fc < 0 & diff == min(diff) ~ Start)) %>%
  filter(!is.na(actual_terminal_peptide)) %>%
  
   # Fragments must contain at least 3 peptides. Missing ends must contain at least 3 peptides
   # Hasn't been calibrated except for nterm and missing c term
     mutate(toosmallfrag=  case_when(
     terminal == "nterm" & observed_nterm <= 3 ~ "toosmall", # Actually only 2 observed
     terminal == "cterm" & observed_cterm <= 4 ~ "toosmall",# Actually only 2 observed
     terminal == "nterm" & missing_cterm <= 3 ~ "toosmall", # Actually missing 2 peptides
     terminal == "cterm" & missing_nterm < 3 ~ "toosmall",
     TRUE  ~ "fine"
     
   )) %>%
  filter(toosmallfrag == "fine") %>%
  select(-toosmallfrag) %>% 
  unique %>%
  ungroup

bps_identified %>%
  write_csv("data/bps_identified.csv")

bps_identified <- 
  read_csv("data/bps_identified.csv")

# Then go to elution_viewer.Rmd to look
```



# Part 3: Curating proteins with high terminal bias
#### Select proteins with high terminal bias, then confirm with elution_viewer.Rmd
```{r}
priority <- bps_identified %>% 
  separate(ProteinID, into =c(NA, NA, "Entry_name"), sep = "[|]") %>% 
  
  group_by(Entry_name) %>% 
  summarize(max_abs_log2fc = max(abs_log2fc)) %>%
  ungroup %>%
  filter(max_abs_log2fc >= 3) %>%
  #filter(!Entry_name %in% x) %>% 
 # filter(grepl("HUMAN", Entry_name)) %>%
  mutate(checkecd = case_when(Entry_name %in% x ~ TRUE))  %>%
  arrange(desc(max_abs_log2fc ))

more <- priority %>%
  filter(!Entry_name %in% x) %>%
  

```


### Classified fragments from elution viewer
```{r}
data_path = "/project/cmcwhite/data/peptide_elutions/fragment_categorizing/"
fragment_files <- dir(data_path, pattern = "*csv") 

fragment_data <- tibble(filename_proc = fragment_files) %>%
               mutate(file_contents = map(filename_proc, ~ read_csv(file.path(data_path, .)))) %>%
               unnest(cols = c(file_contents))

fragment_data <- fragment_data %>% select(-source, -hyperscore)
fragment_data <- fragment_data %>% unique() # sometimes clicked twice

```



Remove outlier peptides
Don't want a low confidence peptide to be the boundary
```{r}

over2_peptide_counts <- fragment_data %>% 
  group_by(Peptide, Start, End, peakid) %>%
     summarize(n = sum(pepcount)) %>%
  ungroup() %>%
  filter(n >= 2) %>%
  select(-n)

unique_peps_per_fragment <- fragment_data %>% 
  inner_join(over2_peptide_counts) %>%
  group_by(ProteinID, peakid) %>%
     summarize(distinct_peptides = n_distinct(Peptide)) %>%
  ungroup() 


fragment_data_terminal <- fragment_data %>%
  inner_join(over2_peptide_counts) %>%
  filter(!experiment_name %in% c("HEKR_IEX1", "HEKR_IEX2", "HEKB_SEC1")) %>%
  arrange(experiment_name) %>%
    group_by(ProteinID, peakid, term, seqlen) %>%
         summarize(nterm_pos = min(Start), cterm_pos =  max(End), first_pep = first(Peptide), last_pep = last(Peptide), exps= paste(unique(experiment_name), collapse = ", ")) %>%
  ungroup %>%
  select(ProteinID, peakid, term, nterm_pos, cterm_pos, seqlen, first_pep, last_pep, exps) %>%
  separate(ProteinID, into = c(NA, "Entry", "Entry_name"), sep = "[|]", remove = FALSE) %>%
   mutate(loc = case_when(term == "nterm" ~ cterm_pos, 
                          term == "cterm" ~ nterm_pos)) %>%
  mutate(in_SEC = case_when(grepl("SEC", exps) ~ TRUE)) %>%
  mutate(in_IEX = case_when(grepl("IEX", exps) ~ TRUE)) 

fragment_data_terminal %>% write_csv("/project/cmcwhite/data/fragment_data_terminal.csv")
fragment_data_terminal <- read_csv("/project/cmcwhite/data/fragment_data_terminal.csv")

domain_coverage 

## number of unique peptides in fragment



```

# Isoform comparison
### Table of what parts of sequence are missing from uniprot
```{r}
uniprot_missing_human <- read_tsv("uniprot-human-missing-from-isoform.tab")
uniprot_missing_arath <- read_tsv("uniprot-arath-missing-from-isoform.tab")


uniprot_missing  <- bind_rows(uniprot_missing_human, uniprot_missing_arath)
uniprot_missing_tbl <- uniprot_missing  %>% rename(annot = `Alternative sequence`)  %>%
  filter(!is.na(annot)) %>%
  separate_rows(annot, sep= "VAR_SEQ ") %>%
  separate(annot, into = c("altseq", "annot"), sep = ";", extra = "merge") %>%
  separate_rows(`annot`, sep = ";") %>%
  filter(grepl("Missing", annot)) %>%
  mutate(isoforms = str_extract_all(annot, "isoform [a-zA-Z0-9]{1,5}")) %>%
  unnest(isoforms) %>% select(-annot) %>%
  #(altseq = str_replace(altseq, "VAR_SEQ ", "")) %>%
  separate(altseq, into = c("missing_start", "missing_end"), sep = "[.][.]") %>%
  mutate(across(starts_with("missing_"),
                as.numeric)) %>%
  filter(!is.na(missing_end)) %>%
  left_join(meta) #%>%
  #select(-Entry_name)

# Only truncations 
uniprot_truncation_variants <- uniprot_missing_tbl %>%
  unique() %>%
  group_by(Entry,  isoforms) %>%
    mutate(n = n()) %>%
  ungroup %>%
  filter(n == 1) %>% #filter(missing_start == 1 | missing_end == seqlen) %>%
  mutate(term = case_when(missing_start == 1 ~ "cterm", missing_end == seqlen ~ "nterm")) %>%
  filter(!is.na(term))  %>%
  mutate(nterm_pos = case_when(term== "nterm" ~ 1, 
                               term == "cterm" ~ missing_end + 1)) %>%
   mutate(cterm_pos = case_when(term== "nterm" ~ missing_start - 1, 
                                term == "cterm" ~ as.double(seqlen))) %>%
  select(-seqlen, -n)
  
 

```



### This is the best way to do isoform comparison so far
```{r}
candidate_isoform_matches <- fragment_data_terminal %>%

  separate(ProteinID, into = c(NA, "Entry", NA), sep = "[|]", remove = FALSE) %>%

  inner_join(uniprot_truncation_variants, by = c("Entry", "term"), suffix = c("_obs", "_iso")) %>% 
  select(-missing_start, -missing_end, -Entry) %>% 
  select(ProteinID, nterm_pos_obs, cterm_pos_obs, nterm_pos_iso, cterm_pos_iso, term,  isoforms, exps, seqlen) %>%
  filter(nterm_pos_obs >= nterm_pos_iso) %>%
    filter(cterm_pos_obs <= cterm_pos_iso) %>%
  unique() 


identified_isoforms <- candidate_isoform_matches %>% 
   mutate(obs_len = cterm_pos_obs - nterm_pos_obs) %>%
     mutate(iso_len = cterm_pos_iso - nterm_pos_iso) %>%
  mutate(ratio = obs_len / iso_len)  %>%
  arrange(desc(ratio)) %>% 
  filter(iso_len - obs_len < 500) %>% 
  filter(ratio > 0.5) %>%
  mutate(obs_span = paste0(nterm_pos_obs, "-", cterm_pos_obs )) %>%
  mutate(iso_span = paste0(nterm_pos_iso, "-", cterm_pos_iso )) %>%
  filter(!grepl("GCF", ProteinID)) %>%# Not close enought
  mutate(isoforms = case_when(isoforms == "isoform Crk" ~ "isoform Crk-I", 
                              TRUE ~ isoforms))   # Manual adjust around bad regex
identified_isoforms  %>% View


library(kableExtra)
identified_isoforms_formatted <- identified_isoforms %>% 

  select(ProteinID, Terminus = term, Observed = obs_span, Isoform = iso_span, `Isoform ID` = isoforms, `Sequence length` = seqlen, `Observed experiments` = exps) 
 
kable(identified_isoforms_formatted, "html", booktabs = T, padding = 0) %>% 
  kable_styling()
# Table 1

# , #col.names = c("virNOG ID", "In text name", "Arabidopsis Uniprot", "Arabidopsis Locus")) %>%

# BTF3_HUMAN, matches isofo rm 2, but has N terminus?
# CATC_HUMAN has additional peptide that reaches to 106 (one count), but it does have a c-terminus. could check isoform specific peptide
# WDR44_HUMAN matches isoform 3
# NLTP_HUMAN matches isoform Scp
# PUR2_HUMAN matches isoform short
# RFC4 could match isoform 
# LARP4_HUMAN matches isoform 7
# NUP98_HUMAN matches isoform 3
# AMOT_HUMAN matches isoform 2
# CRK_HUMAN matches isoform Cr


#BTF3_HUMAN, CATC_HUMA


```
UBP15 has a fragment that's a similar length to isoform3, but has a different terminal peptide. 
Combined with the c-terminal observation, likely a proteolysis


# What domains are in which fragments?
```{r}

# Get domains fully contained in fragments
fragment_domains_auto <- fragment_data_terminal %>% 
  inner_join(meta) %>%
  filter(!is.na(seqlen)) %>%

  left_join(domains_pfam) %>%
     filter(ProtBegin >= nterm_pos & ProtEnd <= cterm_pos) 

fragment_domains_auto_annot <- fragment_domains_auto %>% select(ProteinID, peakid, term, Interpro_ID, Annotation) %>%
  group_by(ProteinID, peakid, term) %>%
    summarize(Interpro_IDs= paste0(Interpro_ID, collapse = ', '),Domains= paste0(Annotation, collapse = ', ')) %>%
  ungroup 

domains_pfam

```



# Supplemental table 1, annotation of all found fragments
```{r}

identified_isoforms_formatted_annot <- identified_isoforms  %>%
  select(ProteinID, term, isoforms)

orthologous_stats <- fragment_data_terminal %>%
  left_join(orthologies)  %>%
  select(ID, ProteinID) %>%
  unique %>%
     group_by(ID) %>%
       summarize(nprotsingroup = n_distinct(ProteinID)) %>%
  ungroup

fragment_data_terminal_annotated <- fragment_data_terminal %>%
  left_join(orthologies) %>%
  left_join(orthologous_stats) %>%
  left_join(unique_peps_per_fragment ) %>%
  left_join(identified_isoforms_formatted_annot) %>%
  left_join(fragment_domains_auto_annot)
fragment_data_terminal_annotated %>%
  select(`euNOG ID` = ID, `Truncated proteins in euNOG group` = nprotsingroup, ProteinID, `ProteoformID` = peakid, Category = term, `First observed aa` = nterm_pos, `Last observed aa` = cterm_pos, `Full sequence length` = seqlen,  `In size exclusion` = in_SEC, `In ion exchange` = in_IEX, `First observed peptide`= first_pep,  `Last observed peptide`= last_pep, `Unique peptides` = distinct_peptides, `Candidate Uniprot isoform` = isoforms, `Observed experiments` = exps, `Full domains contained`= Domains, `Interpro domain IDs`= Interpro_IDs ) %>%
  arrange(desc(`Truncated proteins in euNOG group`), `euNOG ID`, ProteinID) %>%
  write_xlsx("Supplemental_File1.xlsx")




```

# Figures 


# Figure 3A: Calpastatin
```{r}

# plots as IEX then SEC
calp_hemo <-    short_tidy_unique %>%  filter(ProteinID == "sp|P20810|ICAL_HUMAN") %>% #
 
  filter(grepl("HEMO", experiment_name)) %>%
  filter(experiment_name %in% c("HEMO_SEC2", "HEMO_IEX1")) %>%
  mutate(experiment_name = fct_relevel(experiment_name,c("HEMO_SEC2", "HEMO_IEX1") ))%>%
  b_w_plot(pubtheme = FALSE)

calp_hek <-short_tidy_unique %>%  filter(ProteinID == "sp|P20810|ICAL_HUMAN") %>% #
 
  filter(grepl("HEK", experiment_name)) %>%
  filter(experiment_name %in% c("HEK_IEX1", "HEK_SEC1")) %>%
    mutate(experiment_name = fct_relevel(experiment_name,c("HEK_SEC1", "HEK_IEX1") )) %>%
  b_w_plot(pubtheme = FALSE)

calp_hemo
calp_hek


Figure_calp <- plot_grid(calp_hek, calp_hemo)

Figure_calp  %>% ggsave("figures/Figure_calp.png", ., width = 3, height = 1.5)
Figure_calp  %>%  ggsave("figures/Figure_calp.pdf", ., width = 3, height = 1.5)


```


USP15 complex for figure 7

```{r}


# HEMO_IEX1, 2, SEC1, 2
usp15 <- short_tidy_unique %>% 
  filter(grepl("UBP15", ProteinID)) %>% 
  filter(grepl("HEMO", experiment_name)) %>%
  b_w_plot()

# HEK_IEX1, 2, SEC1, 2
usp15_hek <- short_tidy_unique %>% 
  filter(grepl("UBP15", ProteinID)) %>% 
  filter(grepl("HEK_", experiment_name))  %>%
  b_w_plot() 

nqo2 <- short_tidy_unique %>% 
  filter(grepl("NQO2", ProteinID)) %>% 
  filter(grepl("HEMO", experiment_name)) %>%
  b_w_plot() 

nqo2_hek <- short_tidy_unique %>% 
  filter(grepl("NQO2", ProteinID)) %>% 
  filter(grepl("HEK_", experiment_name)) %>%
  b_w_plot() 

# Only in hemolysate
tng2 <- short_tidy_unique %>% 
  filter(grepl("HEMO", experiment_name)) %>%
  b_w_plot(pubtheme = TRUE) 


tng2_hek <- short_tidy_unique %>% 
   filter(ProteinID == "sp|Q6ICL3|TNG2_HUMAN") %>% 
  filter(grepl("HEK_", experiment_name)) %>%
  b_w_plot(pubtheme = TRUE) 


ahsp <- short_tidy_unique %>% 
  filter(ProteinID == "sp|Q9NZD4|AHSP_HUMAN") %>% # Pretty good, not in hek though
 
  filter(grepl("HEMO", experiment_name)) %>%
  b_w_plot(pubtheme = TRUE) 


ahsp_hek <- short_tidy_unique %>% 
  filter(ProteinID == "sp|Q9NZD4|AHSP_HUMAN") %>% # Pretty good, not in hek though
 
  filter(grepl("HEK_", experiment_name)) %>%
  b_w_plot(pubtheme = TRUE) 


hemoglobin <- short_tidy_unique %>%
  filter(ProteinID == "sp|P69905|HBA_HUMAN") %>%
    filter(grepl("HEMO", experiment_name)) %>%
  b_w_plot(pubtheme = TRUE) 

plot_grid( hemoglobin, usp15,ncol = 1, rel_heights = c(0.5, 1))


rfc4 <- short_tidy_unique %>% 
  filter(ProteinID == "sp|P35249|RFC4_HUMAN") %>% 
 
#  filter(grepl("HEMO", experiment_name)) %>%
  b_w_plot(pubtheme = FALSE) 



combo <- plot_grid(nqo2, tng2, ahsp, usp15, ncol = 1, rel_heights = c(0.6, 1, 0.5, 3))
combo
combo %>%
  ggsave("figures/usp_tng2_ahsp_nqo2.png", .)
combo %>%
  ggsave("figures/usp_tng2_ahsp_nqo2.pdf", .)




combo_hek <- plot_grid(nqo2_hek, usp15_hek, ncol = 1, rel_heights = c(1, 1))
combo_hek %>%
  ggsave("figures/usp_nqo2_hek.png", .)
combo_hek %>%
  ggsave("figures/usp_nqo2_hek.pdf", .)


```


# Figure 4?
#### Elution plots, individual cases
```{r}
short_tidy_unique_peaks %>% 
    filter(grepl("MTV1_ARATH", ProteinID)) %>% 
  ggplot(aes( color = as.factor(peak), alpha = pepcount)) +
       geom_point(aes(x = Start, y = FractionOrder)) +
  facet_wrap(~experiment_name, scales = "free_y")

short_tidy_unique_peaks %>% 
    filter(grepl("VILI4_ARATH", ProteinID)) %>% 
  ggplot(aes( color = as.factor(peak), alpha = pepcount)) +
       geom_point(aes(x = Start, y = FractionOrder)) +
  facet_wrap(~experiment_name, scales = "free_y")

short_tidy_unique_peaks %>% 
    filter(grepl("ACT12_ARATH", ProteinID)) %>% 
  ggplot(aes( color = as.factor(peak), alpha = pepcount)) +
       geom_point(aes(x = Start, y = FractionOrder)) +
  facet_wrap(~experiment_name, scales = "free_y")


short_tidy_unique_peaks %>% 
    filter(grepl("A0A2K3DUW9_CHLRE", ProteinID)) %>% 
  ggplot(aes( color = as.factor(peak))) +
       geom_point(aes(x = Start, y = FractionOrder)) +
  facet_wrap(~experiment_name, scales = "free_y")

short_tidy_unique_peaks %>% 
    filter(ProteinID == "sp|Q13283|G3BP1_HUMAN") %>% 
  filter(experiment_name == "HEK_IEX1") %>%
  ggplot(aes( color = as.factor(peak))) +
       geom_point(aes(x = Start, y = FractionOrder)) +
  facet_wrap(~experiment_name, scales = "free_y")


quick_plot_elution <- function(ProteinID, short_tidy_unique_peaks){
  
  short_tidy_unique_peaks %>% 
    filter(grepl({{ProteinID}}, ProteinID)) %>% 
  ggplot() +
       geom_point(aes(x = Start, y = FractionOrder, alpha = pepcount, label = paste(Peptide, End))) +
  facet_wrap(~experiment_name, scales = "free_y")
  ggplotly()

  
}



```

SF3B1 highlight? Very strong in chlamy, maybe in human
```{r}
#elut_viewer("A0A2K3D1T9_CHLRE", short_tidy_unique, domaindis_setup) # IEX and SEC SF3B1
elut_viewer("SF3B1_HUMAN", short_tidy_unique, domaindis_setup) # IEX and SEC SF3B1
#elut_viewer("Q9FMF9_ARATH ", short_tidy_unique, domaindis_setup) # IEX and SEC SF3B1


#K7KQN4_SOYBN

#TC159_ARATH

preprocess %>% filter(Entry_name %in% c("RPN2_HUMAN")) %>% b_w_plot()


mtv1_plot <- preprocess %>% 
  filter(Entry_name %in% c( "MTV1_ARATH")) %>%
  b_w_plot()
mtv1_plot %>% ggsave("figures/mtv1_plot.png", .,device = "png", width = 8, height = 4,  units = "in")
mtv1_plot  %>% ggsave("figures/mtv1_plot.pdf", ., device = "pdf", width = 8, height = 4, units = "in")


gtf2I_plot <- preprocess %>% 
  filter(Entry_name %in% c( "GTF2I_HUMAN")) %>%
  b_w_plot()

gtf2I_plot %>% ggsave("figures/gtf2I_plot.png", .,device = "png", width = 8, height = 4,  units = "in")

gtf2I_plot  %>% ggsave("figures/gtf2I_plot.pdf", ., device = "pdf", width = 8, height = 4, units = "in")

tc159_plot <- preprocess %>% 
  filter(Entry_name %in% c( "TC159_ARATH", "K7KQN4_SOYBN")) %>%
  b_w_plot()

tc159_plot %>% ggsave("figures/tc159_plot.png", .,device = "png", width = 4, height = 4,  units = "in")

tc159_plot  %>% ggsave("figures/tc159_plot.pdf", ., device = "pdf", width = 4, height = 4, units = "in")


#C-terminus important for interaction with EEF1a https://www.ncbi.nlm.nih.gov/pmc/articles/PMC7139343/
EIF2A_plot <- preprocess %>% 
  filter(Entry_name %in% c( "EIF2A_HUMAN", "A0A2K3DHP9_CHLRE", "Q9CAT3_ARATH", "EF1A3_HUMAN", "EF1A2_HUMAN", "A8J4I3_CHLRE", "A8HX38_CHLRE", "A0A2K3DGR2_CHLRE", "SYMC_HUMAN", "SYMM_HUMAN")) %>%
  b_w_plot()

#A0A2K3E124? 
EIF2A_plot <- preprocess %>% 
   filter(Entry_name %in% c( "EIF2A_HUMAN", "A0A2K3DHP9_CHLRE")) %>%
            b_w_plot()#, "Q9CAT3_ARATH", "EF1A3_HUMAN", "EF1A2_HUMAN", "A8HX38_CHLRE", "A0A2K3DGR2_CHLRE",  "A0A2K3E124_CHLRE", "A0A2K3E246_CHLRE", "A0A2K3D6L9_CHLRE", "A0A2K3DD97_CHLRE", "A8HQJ0_CHLRE")) %>%

  EIF2A_plot %>% ggsave("figures/EIF2A_plot.png", .,device = "png", width = 8, height = 4,  units = "in")

EIF2A_plot  %>% ggsave("figures/EIF2A_plot.pdf", ., device = "pdf", width = 8, height = 4, units = "in")


  
#https://www.ncbi.nlm.nih.gov/pmc/articles/PMC7139343/  "A Retrospective on eIF2Aâ€”and Not the Alpha Subunit of eIF2"


preprocess %>%    filter(Entry_name %in% c("NASP_HUMAN", "CDK1_HUMAN")) %>%   b_w_plot()

catc_plot <- preprocess %>%    filter(Entry_name %in% c( "CATC_HUMAN", "RD21B_ARATH", "RDL4_ARATH", "",  "RD21A_ARATH", "A0A2K3CNP0_CHLRE", "A0A2K3CYQ1_CHLRE",  "A0A2K3DFE4_CHLRE" )) %>%   b_w_plot()
  catc_plot %>% ggsave("figures/catcplot.png", .,device = "png", width = 8, height = 4,  units = "in")
catc_plot  %>% ggsave("figures/catc_plot.pdf", ., device = "pdf", width = 8, height = 4, units = "in")

btf3_plot <- preprocess %>%    filter(Entry_name %in% c( "BTF3_HUMAN")) %>%   b_w_plot()
  btf3_plot %>% ggsave("figures/btf3_plot.png", .,device = "png", width = 8, height = 4,  units = "in")
btf3_plot  %>% ggsave("figures/btf3_plot.pdf", ., device = "pdf", width = 8, height = 4, units = "in")

sf3b1_plot <- preprocess %>%    filter(Entry_name %in% c( "SF3B1_HUMAN")) %>%   b_w_plot()
sf3b1_plot %>% ggsave("figures/sf3b1_plot.png", .,device = "png", width = 8, height = 4,  units = "in")
sf3b1_plot  %>% ggsave("figures/sf3b1_plot.pdf", ., device = "pdf", width = 8, height = 4, units = "in")


# Do this one instead of EIF5B, in humans and chlamy
elut_viewer("EIF2A_HUMAN", short_tidy_unique, domaindis_setup) # IEX and SEC SF3B1
elut_viewer("A0A2K3DHP9_CHLRE", short_tidy_unique, domaindis_setup) # IEX and SEC SF3B1



preprocess %>%
  filter(Entry_name %in% c("DDX5_HUMAN", "DDX21_HUMAN", "DDX17_HUMAN")) %>%
  b_w_plot()


preprocess %>%
  filter(Entry_name %in% c("IF2P_HUMAN", "A0A2K3E0D8_CHLRE", "F4I420_ARATH")) %>%
  b_w_plot()

# Just the helical bundle, and just the disordered c-terminus, doesn't go-elute with other eif3s
EIF_plots <- preprocess %>%
  filter(Entry_name %in% c("EIF3A_HUMAN", "EIF3B_HUMAN", "EIF3B_ARATH", "EIF3A_ARATH", "A0A2K3CZ51_CHLRE", "EIF3B_ARATH", "EIF3C_ARATH", "EIF3D_ARATH", "EIF3E_ARATH", "EIF3H_ARATH", "EIF3F_ARATH")) %>%
  b_w_plot() 


 EIF_plots %>% ggsave("figures/EIF_plots.png", .,device = "png", width = 8, height = 8,  units = "in")
EIF_plots %>% ggsave("figures/EIF_plots.pdf", .,device = "pdf", width = 8, height = 8,  units = "in")


elut_viewer("EIF3A_ARATH", short_tidy_unique, domaindis_setup) # IEX and SEC SF3B1
elut_viewer("EIF3A_HUMAN", short_tidy_unique, domaindis_setup) # IEX and SEC SF3B1

```


```{r}
common_prots  <- 
   c("IF2P_HUMAN", 
                           "NPM_HUMAN", 
                           "NUP98_HUMAN",
                           "ATXB2_HUMAN", 
                           "IF4G1_HUMAN",
                           "IF4G2_HUMAN",
                           "UBP2L_HUMAN",
                           "IMB1_HUMAN",
                           "G3BP1_HUMAN",
                           "DDX21_HUMAN",
                           "HNRPM_HUMAN",
                           "SRRRM2_HUMAN",
                           "TCOF_HUMAN",
                           "ACINU_HUMAN",
                           "DDX3X_HUMAN",
                           "DDX6_HUMAN",
                           "DDX17_HUMAN",
                           "DDX42_HUMAN",
                           "DDX46_HUMAN",
                           "DDX50_HUMAN",
                           "DHX9_HUMAN",
                           "EIF2A_HUMAN",
                           "IF2B_HUMAN",
                           "EI2BG_HUMAN",
                           "IF4B_HUMAN",
                           "IF5_HUMAN",
                           "EIF3A_HUMAN"
                           
                           
                           )
preprocess %>%
  filter(Entry_name %in% common_prots) %>%
  b_w_plot()

# WHERE is ACINU and DDX3X?
fragment_data %>%
  filter(Entry_name %in% common_prots) %>%
  pull(Entry_name) %>% unique

#[1] "DDX17_HUMAN" "DDX21_HUMAN" "DDX42_HUMAN" "DDX46_HUMAN" "DDX6_HUMAN"  "DHX9_HUMAN"  "G3BP1_HUMAN" "HNRPM_HUMAN" "EIF2A_HUMAN" "IF2B_HUMAN" 
#[11] "IF2P_HUMAN"  "IF4G2_HUMAN" "NPM_HUMAN"   "NUP98_HUMAN"

```


Do cases of where fragment found, but no full length(?) detected (not just disordered parts). Check images on preprocess
```{r}

# Get frag/full lengths that contain a domain
prots_w_domains_exps <- 
  fragment_data_terminal  %>%
  separate_rows(   exps, sep = ", " ) %>%
  rename(experiment_name = exps) %>%
    left_join(fragment_domains_auto_annot)  %>%
  filter(!is.na(Domains)) %>%
  select(ProteinID, experiment_name) %>%
  unique()


```

# Figure 6A: Only termini detected
```{r}
first_domain <- domains_pfam %>%
  group_by(Entry) %>%
    mutate(firstdomain = min(ProtBegin)) %>%
  ungroup %>%
  filter(ProtBegin == firstdomain) %>%
  select(Entry, Annotation, firstdomain)


last_domain <- domains_pfam %>%
  group_by(Entry) %>%
    mutate(lastdomain = max(ProtEnd)) %>%
  ungroup %>%
  filter(ProtEnd == lastdomain) %>%
  select(Entry, Annotation, lastdomain)

fragment_data_terminal_prefirst <- fragment_data_terminal %>%
    separate_rows(   exps, sep = ", " ) %>%
  rename(experiment_name = exps) %>%
  filter(term == 'nterm') %>%
    inner_join(first_domain) %>% 
  filter(cterm_pos < firstdomain) 


fragment_data_terminal_postlast <- fragment_data_terminal %>%
    separate_rows(   exps, sep = ", " ) %>%
  rename(experiment_name = exps) %>%
  filter(term == 'cterm') %>%
    inner_join(last_domain) %>% 
  filter(nterm_pos > lastdomain)

bind_rows(fragment_data_terminal_prefirst, fragment_data_terminal_postlast) %>%
  #select(ProteinID, experiment_name) %>% 
  arrange(ProteinID) %>% 
  select(ProteinID, nterm_pos, cterm_pos, term) %>% unique %>% 
  filter(ProteinID %in% proteins_w_full$ProteinID ) %>%
select(ProteinID) %>% unique()


# 28 human proteins where only peptides from termini outside of annotated domains were detected in a fraction experiment. Detection of these peptides without inspecting the peptide coverage could result in unsusp 

# 28 human proteins
# 32 Chlamy proteins
# 11 arabidopsis proteins
bind_rows(fragment_data_terminal_prefirst, fragment_data_terminal_postlast) %>%
  #select(ProteinID, experiment_name) %>% 
  arrange(ProteinID) %>% 
  select(ProteinID, experiment_name, term) %>% unique %>% 
  anti_join(experiments_w_full) %>%
  select(ProteinID) %>% unique %>%
  filter(grepl("HUMAN", ProteinID))


# experiments_w_full not perfect. Instead of this look for peaks that start after/before domain
bind_rows(fragment_data_terminal_prefirst, fragment_data_terminal_postlast) %>%
  #select(ProteinID, experiment_name) %>% 
  arrange(ProteinID) %>% 
  select(ProteinID, nterm_pos, cterm_pos, term, experiment_name) %>% 
  #select(ProteinID, experiment_name, term) %>% unique %>% 
  anti_join(prots_w_domains_exps) %>%
  group_by(ProteinID, nterm_pos, cterm_pos, term) %>%
    summarize(solo_exps = paste0(experiment_name, collapse = ", ")) %>%
  ungroup %>% 
  filter(grepl(",", solo_exps)) %>% filter(grepl("IEX", solo_exps)) %>% filter(grepl("SEC", solo_exps)) %>%
  arrange(nterm_pos, cterm_pos)# %>%
  #filter(grepl("HUMAN", ProteinID))


# USE EIF3B as example
preprocess %>% filter(Entry_name %in% c("INT3_HUMAN", "WDR44_HUMAN", "CTR9_HUMAN", "RFC1_HUMAN",  "EIF3B_HUMAN", "RU17_HUMAN", "SRP72_HUMAN")) %>%
  b_w_plot()

```





```{r}

exp_counts <- short_tidy_unique %>%  
  group_by(ProteinID, experiment_name) %>%
  summarize(counts = sum(pepcount)) %>%
  ungroup()


other_prots <- short_tidy_unique %>%  select(ProteinID, experiment_name) %>% unique %>%
  anti_join(bps_identified) %>%
  mutate(abs_log2fc = 0) # Ones with no gaussians fitted


score_distinguisher <- bps_identified %>% 
  group_by(ProteinID ) %>%
    mutate(max_abs_log2fc = max(abs_log2fc)) %>%
  ungroup %>%
  filter(abs_log2fc == max_abs_log2fc) %>%
    left_join(exp_counts) %>%
 # select(ProteinID, experiment_name,  abs_log2fc) %>%
  left_join(fragment_data_terminal_annot) %>%
  mutate(label = case_when(is.na(label) ~ "Not detected", TRUE ~ "Detected")) 
  #(aes(x = abs_log2fc, color = label, group = label)) +
    #geom_density()
  #filter(abs_log2fc >= 3) %>%

score_distinguisher %>%
  ggplot(aes(x = abs_log2fc, color = label)) +
  geom_density()  +
  scale_color_manual(values = c("blue", "grey"))


score_distinguisher_detect <- score_distinguisher %>% filter(label == "Detected")
score_distinguisher_notdetect <- score_distinguisher %>% filter(label == "Not detected")


#ggplot()
priority_plot <- ggplot() + 
  geom_point_rast(data = score_distinguisher_notdetect, color = "grey", alpha = 0.3, aes(x = counts, y = abs_log2fc)) +
  geom_point(data = score_distinguisher_detect, color = palette[1], alpha = 0.7, aes(x = counts, y = abs_log2fc)) #+
  scale_x_log10() 
  #facet_wrap(~label)

priority_plot %>% ggsave("figures/priority_plot.png", .,device = "png", width = 2.5, height = 2.2,  units = "in")

priority_plot  %>% ggsave("figures/priority_plot.pdf", ., device = "pdf", width = 2.5, height = 2.2, units = "in")

plot_grid(priority_plot, peptide_stats_plot)

```




### Extract out fragment peaks, and do individual correlations
```{r}

extra_copd <- tibble(experiment_name = c("HEK_IEX1","HEK_IEX1","HEK_IEX2","HEK_IEX2","HEK_IEX2"), spec = c("human","human","human","human","human"),
                     ProteinID = rep("cterm-1-A-sp|P48444|COPD_HUMAN", 5), FractionID = c("HEK293T_control_IEX_47a_011217", "HEK293T_control_IEX_48a_011217", "HEK293T_ctrl_IEX_SC_45a_042217", "HEK293T_ctrl_IEX_SC_46a_042217", "HEK293T_ctrl_IEX_SC_49a_042217"), prottot = c(4,3,4,2,1))


cor_setup <- fragment_data_terminal %>%
  mutate(ProteinID = paste(term, nterm_pos, cterm_pos,ProteinID, sep = '-')) %>%

  bind_rows(short_tidy_unique) %>%
  group_by(experiment_name, spec, ProteinID, FractionID ) %>%
   summarize(prottot = sum(pepcount)) %>%
  ungroup 

total_fractions <- cor_setup %>%
  group_by(ProteinID) %>%
    summarize(nfrac_obs = n()) %>%
  ungroup()




get_fragment_cors <- function(cor_setup, total_fractions, exp_counts, minscore, score = "cor"){
  

   cor_setup_filt <- cor_setup %>%

  select(-spec, -experiment_name) %>%
  group_by(ProteinID) %>%
    mutate(total = sum(prottot)) %>%
  ungroup %>%
  filter(total > 15) %>%
  select(-total) %>%
  pivot_wider(names_from = ProteinID, values_from = prottot, values_fill = 0 ) %>%
  select(-FractionID) 


   if(score == "cors"){
      cors <- cor(cor_setup_filt, cor_setup_filt, method  = "pearson") 
   }
   if(score == "profcompare"){
      print(cor_setup_filt)
      cors <- profcompare(cor_setup_filt) 
   }
   
    fragment_cors <- cors %>% 
      as_tibble(rownames = "ID1") %>% 
      gather(ID2, r, -ID1) %>% 
      filter(r >= minscore) %>%
      arrange(desc(r)) %>%
      filter(grepl("nterm", ID1) | grepl("cterm", ID1)) %>%
      filter(ID1 != ID2) %>%
      left_join(exp_counts, by = c("ID1" = "ProteinID")) %>%
      arrange(desc(nexps)) %>%
      separate(ID1, into = c(NA, "Entry1", "Entry_name1"), sep = "[|]", remove = FALSE) %>%
      separate(ID2, into = c(NA, "Entry2", "Entry_name2"), sep = "[|]", remove = FALSE) %>% 
      left_join(total_fractions, by = c("ID1" = "ProteinID")) %>%
       left_join(total_fractions, by = c("ID2" = "ProteinID")) 
   return(fragment_cors)
 
}

cor_setup %>% filter(grepl("A8I901", ProteinID)) %>% filter(spec == "chlre")  %>% get_fragment_cors(., total_fractions, exp_counts, 0.5, "cors")

cors_chlre <- cor_setup %>% filter(spec == "chlre")  %>% get_fragment_cors(., total_fractions, exp_counts, 0.5, "cors")
cors_human <- cor_setup %>% filter(spec == "human")  %>% bind_rows(extra_copd) %>% get_fragment_cors(., total_fractions, exp_counts, 0.5, "cors")
cors_arath <- cor_setup %>% filter(spec == "arath")  %>% get_fragment_cors(., total_fractions, exp_counts, 0.5, "cors")
  
source("scripts/profcompare.R")
test_profcompare <- profcompare(cor_setup_filt) 

cors_chlre <- cor_setup %>% filter(spec == "chlre")  %>% get_fragment_cors(., total_fractions, exp_counts, 0.8, "profcompare")
cors_human_profcompare <- 
  cor_setup %>% filter(spec == "human")  %>%
    
  #  filter(ProteinID %in% c("sp|Q8N0W3|FUK_HUMAN", "cterm-3-A-sp|Q9Y4E8|UBP15_HUMAN")) %>% 
     # filter(ProteinID %in% c("cterm-2-A-sp|Q29RF7|PDS5A_HUMAN", "sp|Q99618|CDCA3_HUMAN")) %>%

  #filter(ProteinID %in% c("cterm-2-A-sp|Q13263|TIF1B_HUMAN", "cterm-2-A-sp|Q8N1G4|LRC47_HUMAN")) %>% 
    get_fragment_cors(., total_fractions, exp_counts, 0.3, "profcompare")
  
cors_human_profcompare   %>% write_csv("cors_human_profcompare.csv")
cors_human_profcompare   <- read_csv("cors_human_profcompare.csv")



cors_human_profcompare %>%
  mutate(fraction_fraction = nfrac_obs.x/nfrac_obs.y) %>%
  # Get proteins that are observed in about the same # of fractions
  filter(fraction_fraction > 0.8) %>%
  filter(fraction_fraction < 1.2) %>%
  
  arrange(desc(r)) %>%
  filter(nfrac_obs.x > 100) %>% View()
  ggplot(aes(x = nfrac_obs.x, y = r, label = paste0(ID1, "-", ID2))) +
    geom_point(alpha = 0.7) +
  scale_x_log10() 


#cors_arath <- cor_setup %>% filter(spec == "arath")  %>% get_fragment_cors(., total_fractions, exp_counts, 0.7, "profcompare")
  


uniprot_arath_annot <- read_tsv("/project/cmcwhite/data/protein_complexes_plant/accessory_files/unused/uniprot_arath_annotations.txt") %>%
  select(Entry, `Protein names`)

exp_counts <- fragment_data %>% 
  mutate(ProteinID = paste(term, peakid,candidate,ProteinID, sep = '-')) %>%
  select(ProteinID, experiment_name) %>% unique %>%
  group_by(ProteinID) %>%
    summarize(nexps = n()) %>%
  ungroup %>%
   arrange(desc(nexps))

cors_arath %>% arrange(desc(r))
preprocess %>%
  filter(Entry_name %in% c("PHOT1_ARATH",  "CIP1_ARATH", "AB14C_ARATH", "PLDD1_ARATH")) %>%
  b_w_plot()

# Good matches, unknown biology, only one experiment
preprocess %>%
  filter(Entry_name %in% c("IF4G1_ARATH",  "PER45_ARATH", "Q9LHQ4_ARATH")) %>%
  b_w_plot()

# Look at combo_score > 0.6
bind_rows(cors_human, cors_arath, cors_chlre) %>%
  rowwise() %>%
  mutate(diff = min(nfrac_obs.x,nfrac_obs.y)/  max(nfrac_obs.x,nfrac_obs.y)) %>%
  mutate(combo_score = diff * r) %>% View()
  ggplot() +
  geom_point(aes(size = nfrac_obs.x, x = diff, y = r, color = combo_score, label = paste0(Entry_name1, "-", Entry_name2)), alpha = 0.7) 
  
  # Good match, only one exp though
preprocess %>% filter(Entry_name %in% c("Q6V8K6_CHLRE", "A0A2K3DHN7_CHLRE" )) %>% b_w_plot(  
  # Good match, two experiments
  
  # Get together all the vid27 guys A0A2K3CTA4_CHLRE = vid27 chlre . Wasn't there an arabidopsis one?
  #Check that that "A0A2K3DIS4_CHLRE C-tmerinual is annotated
  preprocess %>% filter(Entry_name %in% c("A0A2K3CTA4_CHLRE","A0A2K3DIS4_CHLRE" )) %>% b_w_plot()
  
preprocess %>% filter(Entry %in% c("A8I901", "A8ID95", "A8JAD5", "A0A2K3CWJ9", "A0A2K3E2J7", "A0A2K3CTA4", "A0A2K3D5T6", "A0A2K3CPC9", "A0A2K3CNL6",  "A8J353", "A8JGV8", "P42380" )) %>% b_w_plot()

#### 
# COPD chlamy A8ID95 = pretty good cLPa3
preprocess %>%
  filter(Entry %in% c("A8I901", "A8ID95", "A8JAD5", "A0A2K3CWJ9", "A0A2K3E2J7", "A0A2K3CTA4", "A0A2K3D5T6", "A0A2K3CPC9", "A0A2K3CNL6",  "A8J353", "A8JGV8", "P42380" )) %>%
  b_w_plot()

preprocess %>%
  filter(Entry_name %in% c("COPD_HUMAN", "CHM4A_HUMAN"))%>%
  b_w_plot()

# DSC1, ECM1, SPB12, def go together in erythrocytes, not sure about fragment. Very low coverage
preprocess %>%
  filter(Entry %in% c("Q08554", "Q16610", "Q96P63")) %>%
  b_w_plot()

#nterm-2-A-sp|O65570|VILI4_ARATH
#sp|Q9LV35|AIP12_ARATH
#0.446032243
#2
#Villin-4
#Actin-interacting protein 1-2


#PUR2N sometimes with PUR6, PUR2full sometimes with PUR6N
preprocess %>%
  filter(Entry_name %in% c("PUR1_HUMAN", "PUR2_HUMAN","PUR3_HUMAN", "PUR4_HUMAN", "PUR5_HUMAN", "PUR6_HUMAN"))%>%
  b_w_plot()

preprocess %>%
  filter(Entry_name %in% c("PUR2_HUMAN", "PUR6_HUMAN"))%>%
  b_w_plot()

test_cor %>% 
  as_tibble(rownames = "ID1") %>% 
  gather(ID2, r, -ID1) %>%
  arrange(desc(r)) %>%
  filter(grepl("cterm", ID1)) %>%
  filter(ID1 != ID2) %>%
  left_join(exp_counts, by = c("ID1" = "ProteinID")) %>%
  arrange(desc(nexps))

	


cor_setup%>%
  filter(ProteinID %in% c("nterm-3-A-sp|P48634|PRC2A_HUMAN", "cterm-3-A-sp|Q5JSH3|WDR44_HUMAN")) %>%
  pivot_wider(names_from= FractionID, values_from = prottot) %>% View

cor_setup%>%
  filter(ProteinID %in% c("nterm-2-A-sp|Q9Y4E8|UBP15_HUMAN", "sp|P16083|NQO2_HUMAN")) %>%
  pivot_wider(names_from= FractionID, values_from = prottot) %>% View

cor_setup%>%
  filter(ProteinID %in% c("cterm-2-A-sp|Q29RF7|PDS5A_HUMAN", "sp|Q99618|CDCA3_HUMAN")) %>%
  pivot_wider(names_from= FractionID, values_from = prottot) %>% View



cor_setup%>%
  filter(ProteinID %in% c("internal-2-A-tr|A8I2U9|A8I2U9_CHLRE", "cterm-2-A-tr|Q6UPR1|Q6UPR1_CHLRE")) %>%
  pivot_wider(names_from= FractionID, values_from = prottot) %>% View

# Pretty good match
cor_setup%>%
  filter(ProteinID %in% c("cterm-3-A-sp|O48963|PHOT1_ARATH", "sp|F4JZY1|CIP1_ARATH", "sp|Q9LZJ5|AB14C_ARATH")) %>%
  pivot_wider(names_from= FractionID, values_from = prottot) %>% View
elut_viewer("PHOT1_ARATH", short_tidy_both, domaindis_setup)
elut_viewer("CIP1_ARATH", short_tidy_both, domaindis_setup)

# Pretty nice!
# Vid27 with Mg-protoporphyrin IX chelatase
# Interpretation?
short_tidy_both_prot %>%
  filter(ProteinID %in% c("cterm-3-A-tr|A0A2K3CTA4|A0A2K3CTA4_CHLRE", "full-1-A-tr|A8I531|A8I531_CHLRE", "tr|A0A2K3DIS4|A0A2K3DIS4_CHLRE")) %>%
  pivot_wider(names_from= FractionID, values_from = prottot) %>% View


a <- short_tidy_unique %>% 
    filter(grepl("HEK", experiment_name)) %>%
  filter(ProteinID == "sp|Q8NC51|PAIRB_HUMAN") %>% 
  b_w_plot() 
b <-  short_tidy_unique %>% 
    filter(grepl("HEK", experiment_name)) %>%
  filter(ProteinID == "sp|Q8WWM7|ATX2L_HUMAN") %>% 
  b_w_plot() 
  
c <- short_tidy_unique %>% 
  filter(grepl("HEK", experiment_name)) %>%
  filter(ProteinID == "sp|P52272|HNRPM_HUMAN") %>% 
  b_w_plot() 
  

plot_grid(a,b, c,ncol = 1)


#???
a <- short_tidy_unique %>% 
    filter(grepl("HEK", experiment_name)) %>%
  filter(ProteinID == "sp|Q8N1G4|LRC47_HUMAN") %>% 
  b_w_plot() 
b <-  short_tidy_unique %>% 
    filter(grepl("HEK", experiment_name)) %>%
  filter(ProteinID == "sp|Q13263|TIF1B_HUMAN") %>% 
  b_w_plot() 

plot_grid(a,b, ncol = 1)
cor_setup%>%
  filter(ProteinID %in% c("cterm-2-A-sp|Q8N1G4|LRC47_HUMAN", "cterm-2-A-sp|Q13263|TIF1B_HUMAN")) %>%
  pivot_wider(names_from= FractionID, values_from = prottot) %>% View


# VID27 in arabidopsis has chloroplast links
# Cloned by lianyong Cre16.g657550
# Nice match
elut_viewer("A0A2K3CTA4_CHLRE", short_tidy_both, domaindis_setup)
elut_viewer("A8I531_CHLRE", short_tidy_both, domaindis_setup)

short_tidy_both_prot %>%
  filter(ProteinID %in% c("nterm-3-A-tr|A0A2K3DPK1|A0A2K3DPK1_CHLRE", "tr|A0A2K3E2S5|A0A2K3E2S5_CHLRE")) %>%
  pivot_wider(names_from= FractionID, values_from = prottot) %>% View

elut_viewer("A0A2K3DPK1_CHLRE", short_tidy_both, domaindis_setup)
elut_viewer("A0A2K3D3A9_CHLRE", short_tidy_both, domaindis_setup)

#% in common?
# weighted detection similarity?
# same frac = TRUE
# diff frac = FALSE
# tot frac = n

short_tidy_both_prot %>%
  filter(ProteinID %in% c("nterm-2-A-sp|O65570|VILI4_ARATH", "sp|Q9LV35|AIP12_ARATH")) %>%
  pivot_wider(names_from= FractionID, values_from = prottot) %>% View

short_tidy_both_prot %>%
  filter(ProteinID %in% c("cterm-3-A-tr|F4I420|F4I420_ARATH", "sp|Q56Y85|MAP22_ARATH")) %>%
  pivot_wider(names_from= FractionID, values_from = prottot) %>% View

# Ok ish, glucosidase + alcohol dehydrogenase
short_tidy_both_prot %>%
  filter(ProteinID %in% c("cterm-2-A-sp|Q9FZE0|BGL40_ARATH", "tr|Q9LK96|Q9LK96_ARATH")) %>%
  pivot_wider(names_from= FractionID, values_from = prottot) %>% View



elut_viewer("F4I420_ARATH", short_tidy_both, domaindis_setup)
elut_viewer("MAP22_ARATH", short_tidy_both, domaindis_setup)

# EIF5B with protein that removes initial methionine? MAP22 EIF2S1 associated.
# Check in chlamydomonas
short_tidy_both_prot %>%
  filter(ProteinID %in% c("cterm-3-A-tr|F4I420|F4I420_ARATH", "sp|Q56Y85|MAP22_ARATH")) %>%
  pivot_wider(names_from= FractionID, values_from = prottot) %>% View
elut_viewer("F4I420_ARATH", short_tidy_both, domaindis_setup)
elut_viewer("MAP22_ARATH", short_tidy_both, domaindis_setup)

short_tidy_both %>% filter(ProteinID == "tr|F4I420|F4I420_ARATH") %>%
  select(ID)
short_tidy_both %>% filter(ID == "KOG1144") %>%
  filter(spec== "human") %>%
  select(ProteinID)

#tr|A0A2K3E0D8|A0A2K3E0D8_CHLRE
#tr|A8J9E6|A8J9E6_CHLRE
elut_viewer("IF2P_HUMAN", short_tidy_both, domaindis_setup)
elut_viewer("MAP2_HUMAN", short_tidy_both, domaindis_setup)
```


```{r}

complexportal <- read_tsv("outside_data/complex_portal_w_fragment_12_01_20.tsv", col_names = FALSE) %>%
   select(complex_id = X1, complex_annot = X2, entries = X5) %>%
  separate_rows(entries, sep  =  "[|]") %>%
  mutate(Entry = str_extract(entries, "^......")) %>%
  select(-entries) %>% unique()
  

#bp_protein <-  fragment_data_terminal %>% separate(ProteinID, into = c(NA, "Entry", "Entry_name"), sep = "[|]", remove = FALSE) %>% unique()
#complexportal %>%
#    inner_join(bp_protein) #%>% filter(!is.na(bpprot)) %>%
#  View()

  

fragment_data_preprocess <- fragment_data_terminal %>%
    separate(ProteinID, into = c(NA, "Entry", "Entry_name"), sep = "[|]", remove = FALSE) 

fragments_in_complexportal <- complexportal %>%  
  inner_join(fragment_data_preprocess) %>%
  select(complex_id, ProteinID, Entry) %>% unique

reject <- c()
#"sp|Q92922|SMRC1_HUMAN" 
#"sp|Q13112|CAF1B_HUMAN" No
#"sp|Q6IA86|ELP2_HUMAN" Yes? Mixed evidence 
#"sp|Q9NR30|DDX21_HUMAN" 
#"sp|P04844|RPN2_HUMAN"  
#"sp|P51610|HCFC1_HUMAN"
#"sp|P20290|BTF3_HUMAN" No
#"sp|Q08211|DHX9_HUMAN"  No
#"sp|P49792|RBP2_HUMAN"  
#"sp|P52948|NUP98_HUMAN"

complexportal  %>% filter(Entry == "P04844")

#"P61165" "Q9H0U3" "Q14165" "A0A024" "P04844" "P04843" "P61803" "P0C6T2" "Q8TCJ2"
complexportal %>% filter(complex_id == "CPX-5622") %>% pull(Entry)
# CPX-1080 CRD-mediated mRNA stability complex Q08211 Q00839

#CPX-873 Nuclear pore complex P49792 P52948 

#OST CPX
#Why was P39656 missig from complexportal?
ost <- c("P0C6T2", "P61165","Q9NRP0", "Q9H0U3", "Q14165", "A0A024", "P04844", "P04843", "P61803", "P0C6T2" ,"Q8TCJ2", "P39656")
#RPN2 lineage specific extension?

preprocess <- short_tidy_unique %>% #_labeled_peaks%>% 
  separate(ProteinID, into = c(NA, "Entry", "Entry_name"), sep = "[|]", remove = FALSE) %>%
  left_join(complexportal)

 short_tidy_unique %>% filter(grepl("F4JIM7", ProteinID))  
 
   short_tidy_unique %>% filter(grepl("RPN2_ARATH", ProteinID))  
  
   
preprocess %>% filter(Entry %in% ost) %>%
  b_w_plot()

#sp|Q92922|SMRC1_HUMAN
#sp|Q13112|CAF1B_HUMAN
#sp|Q6IA86|ELP2_HUMAN 
#sp|Q14974|IMB1_HUMAN 
#sp|Q9NR30|DDX21_HUMAN
#sp|P04844|RPN2_HUMAN 
#sp|P51610|HCFC1_HUMAN
#sp|P20290|BTF3_HUMAN 
#sp|Q00839|HNRPU_HUMAN
#sp|Q08211|DHX9_HUMAN 
#sp|P49792|RBP2_HUMAN 
#sp|P52948|NUP98_HUMAN
#sp|P60900|PSA6_HUMAN 
#sp|Q8TEQ6|GEMI5_HUMAN

```

  
```{r}
#https://www.researchgate.net/figure/Overview-of-the-structure-of-the-a-COP-CTD-e-COP-heterodimer-A-Domain-structures-of_fig1_44660041 Not seen in human

preprocess %>% filter(Entry_name %in% c("COPA1_ARATH", "COPA2_ARATH", "A0A1P8B4C2_ARATH", "COPB1_ARATH", "COPB2_ARATH", "COPE1_ARATH", "COPE2_ARATH", "COPG_ARATH","Q9XIH0_ARATH","F4IKA7_ARATH")) %>%
b_w_plot()  


# COPE, COPA chlamy
preprocess %>% filter(Entry %in% c("A8IWB5","A0A2K3CZA0")) %>%
filter(experiment_name %in% c("CHLRE_SEC1", "CHLRE_SEC2")) %>%
  b_w_plot() 


# COPA(chlre, chlamdy)
preprocess %>% filter(Entry %in% c("Q9SJT9","A0A2K3CZA0")) %>%
filter(experiment_name %in% c("CHLRE_SEC1", "CHLRE_SEC2")) %>%
  b_w_plot() 



# COPD, COPA arabidopis
preprocess %>% filter(Entry %in% c("Q9SJT9", "Q93Y22")) %>%
filter(experiment_name %in% c("ARATH_SEC1")) %>%
  b_w_plot() 

# COPA arabidopis
COPA_arath_plot <- preprocess %>% filter(Entry %in% c("Q9SJT9")) %>%
filter(experiment_name %in% c("ARATH_SEC1")) %>%
  b_w_plot()
 
COPA_arath_plot %>% ggsave("figures/COPA_arath_plot.png", .,device = "png", width =5, height = 5,  units = "in")
COPA_arath_plot %>% ggsave("figures/COPA_arath_plot.pdf", ., device = "pdf", width = 5, height = 5, units = "in")




# COPD, chlamy
preprocess %>% filter(Entry %in% c("A8I901")) %>%
  filter(experiment_name %in% c("CHLRE_IEX1", "CHLRE_SEC1")) %>%
  b_w_plot() 

# COPE, human "O14579"
preprocess %>% filter(Entry %in% c("O14579")) %>%
 # filter(experiment_name %in% c("CHLRE_IEX1", "CHLRE_SEC1")) %>%
  b_w_plot() 

# Chlamy ones
preprocess %>% filter(Entry %in% c("A8JGS8", "A0A2K3DRN1", "A8I901", "A8IM71", "A0A2K3CZA0", "A8IWB5", "A8HRR9", "A8JHN4", "A8JEP9", "A0A2K3DTG4", "A8JET7", "A0A2K3DH79")) %>%
  b_w_plot()

# Chlamy copD copE
preprocess %>% filter(Entry %in% c("A8I901",  "A8IWB5")) %>%
  b_w_plot()

# Arabidopsis
preprocess %>% filter(Entry %in% c("B3H5Z4", "Q94A40", "Q9SJT9", "A0A1P8B4C2", "F4ICX0", "F4J1E5", "F4HQE7", "A0A1I9LTK3", "A0A1P8AV73", "Q9SV21", "Q9CAA0", "Q9SV20", "Q9C827", "Q8L828", "Q93Y22", "Q9SA78", "O64748", "Q0WW26", "A0A1I9LRF5", "A0A1I9LRF7", "Q9XI32", "A0A1I9LRF9", "Q940S5", "Q84LG4", "Q8H1F4")) %>%
  b_w_plot()

preprocess %>% filter(Entry %in% c("P53621", "P35606", "P53618", "P48444", "O14579", "Q9Y678", "Q9UBF2", "P61923", "Q9P299")) %>%
  b_w_plot()

# Consisestent  in chlamy and humans that COPD has a second non-COP interaction interaction, potentially missing n-terminus. What is this from?

# In chlamy, cope also has a second interaction (A8IWB5)

# TOC159/TOC75 complex A-Domain
fig_toc <- preprocess %>% filter(Entry_name %in% c("TC159_ARATH","TC753_ARATH")) %>%
  b_w_plot() 

fig_toc  %>% ggsave("figures/fig_toc.png", ., width = 3, height = 3)
fig_toc  %>%  ggsave("figures/fig_toc.pdf", ., width = 3, height = 3)

preprocess %>% filter(Entry_name %in% c("K7KQN4_SOYBN", "I1MDC4_SOYBN") )%>%
  b_w_plot()

preprocess %>% filter(Entry_name %in% c("A0A2K3CR90_CHLRE", "A8IE32_CHLRE"))  %>% b_w_plot()


```
  
  
```{r}
 

preprocess %>%
  filter(grepl("Q9NRP0", ProteinID))
#filter(grepl("A0A2K3DH22", ProteinID)) %>%
#filter(grepl("Q93Z16", ProteinID)) %>%
 

  #filter(complex_id == "CPX-1196") %>%
#filter(complex_id == "CPX-1201") %>%
#filter(complex_id == "CPX-1194") %>%
#filter(complex_id == "CPX-1223") %>%
#filter(complex_id == "CPX-1226") %>%
#filter(complex_id == "CPX-569") %>%
#filter(complex_id == "CPX-1949") %>%
#filter(complex_id == "CPX-1099") %>%
#filter(complex_id == "CPX-5622") %>%  # OST B
#filter(complex_id == "CPX-5621") %>% # OST A
 #filter(Entry %in% ost) %>%
#filter(complex_id == "CPX-809") %>%
#filter(complex_id == "CPX-676") %>%
#filter(complex_id == "CPX-1080") %>%
#filter(complex_id == "CPX-1202") %>%
#filter(complex_id == "CPX-1204") %>%
#filter(complex_id == "CPX-1205") %>%
#filter(complex_id == "CPX-1207") %>%
#filter(complex_id =="CPX-1210") %>%
#filter(complex_id =="CPX-1211") %>%
#filter(complex_id == "CPX-1213") %>%
#filter(complex_id == "CPX-1164") %>%
#filter(complex_id == "CPX-1199") %>%
#filter(complex_id == "CPX-1206") %>%
#filter(complex_id == "CPX-1225") %>%
#filter(complex_id == "CPX-1195") %>%
#filter(complex_id == "CPX-1209") %>%
#filter(complex_id == "CPX-1212") %>%
#filter(complex_id == "CPX-1227") %>%
#filter(complex_id == "CPX-1228") %>%
#filter(complex_id == "CPX-1215") %>%
#filter(complex_id == "CPX-1216") %>%
#filter(complex_id == "CPX-1217") %>%
#filter(complex_id == "CPX-1218") %>%
#3filter(complex_id == "CPX-1222") %>%
#filter(complex_id == "CPX-1224") %>%
#filter(complex_id == "CPX-4747") %>%
#filter(complex_id == "CPX-873") %>%
#filter(complex_id == "CPX-873") %>%
#filter(complex_id == "CPX-4084") %>%
#filter(complex_id == "CPX-4223") %>%
#filter(complex_id == "CPX-4224") %>%
#filter(complex_id == "CPX-4225") %>%
#filter(complex_id == "CPX-4226") %>%
#filter(complex_id == "CPX-4203") %>%
#filter(complex_id == "CPX-4206") %>%
#filter(complex_id == "CPX-4207") %>%
#filter(complex_id == "CPX-4922") %>%
 
  b_w_plot()  
   # CPX-1080 CRD-mediated mRNA stability complex Q08211 Q00839
   # N terminal fragments together
   #filter(Entry %in% c("Q08211", "Q00839")) %>% 
   # Add nup98
   # filter(Entry %in% c("Q08211", "Q00839", "P52948")) %>% 
   # CPX-873 Nuclear pore complex P49792 P52948
 #  filter(Entry %in% c("P49792", "P52948")) %>% 
   #filter(Entry %in% c("Q9NR30", "P35659", "Q9UKV3")) %>% # 
  #filter(Entry %in% c("A0A2K3DAW8", "A0A2K3DYR4", "A8I9S6", "A0A2K3CNP4"))  %>%
  #  filter(Entry %in% c("Q9UKV3", "Q15287")) %>% 
   

  ggplot() +
       geom_point(aes(x = Start, y = FractionID ,alpha = pepcount)) +
     coord_flip() +
  scale_color_manual(values = palette) +
  scale_x_reverse() +
  background_grid() +
  facet_wrap(experiment_name ~ Entry, scales = "free_y", dir = "v")





    #left_join(bps_identified_annot) %>% 
preprocess %>%
   # CPX-1080 CRD-mediated mRNA stability complex Q08211 Q00839
   # N terminal fragments together
   #filter(Entry %in% c("Q08211", "Q00839")) %>% 
   # Add nup98
   # filter(Entry %in% c("Q08211", "Q00839", "P52948")) %>% 
   # CPX-873 Nuclear pore complex P49792 P52948
   filter(Entry %in% c("P49792", "P52948")) %>% 
   #filter(Entry %in% c("Q9NR30", "P35659", "Q9UKV3")) %>% # 
  #filter(Entry %in% c("A0A2K3DAW8", "A0A2K3DYR4", "A8I9S6", "A0A2K3CNP4"))  %>%
  #  filter(Entry %in% c("Q9UKV3", "Q15287")) %>% 
   
  ggplot() +
       geom_point(aes(x = Start, y = FractionID ,alpha = pepcount)) +
     coord_flip() +
  scale_color_manual(values = palette) +
  scale_x_reverse() +
  background_grid() +
  facet_wrap(experiment_name ~ Entry, scales = "free_y", dir = "v")

preprocess %>%
   # CPX-1080 CRD-mediated mRNA stability complex Q08211 Q00839
   # N terminal fragments together
   filter(Entry %in% c("Q08211", "Q00839")) %>% 
  ggplot() +
       geom_point(aes(x = Start, y = FractionID ,alpha = pepcount)) +
     coord_flip() +
  scale_color_manual(values = palette) +
  scale_x_reverse() +
  background_grid() +
  facet_wrap(experiment_name ~ Entry_name, scales = "free_y", dir = "v")

preprocess %>%
   # CPX-1080 CRD-mediated mRNA stability complex Q08211 Q00839
   # N terminal fragments together
    filter(Entry %in% c("Q08211", "Q00839", "P52948")) %>% 
  ggplot() +
       geom_point(aes(x = Start, y = FractionID ,alpha = pepcount)) +
     coord_flip() +
  scale_color_manual(values = palette) +
  scale_x_reverse() +
  background_grid() +
  facet_wrap(experiment_name ~ Entry_name, scales = "free_y", dir = "v")

# KEEP 
#ELP2 N terminal fragment does not co-elute with ELP3 and ELP4
preprocess %>%
   # CPX-1080 CRD-mediated mRNA stability complex Q08211 Q00839
   # N terminal fragments together
    filter(Entry %in% c("Q96EB1", "Q0PNE2" ,"Q8TE02" ,"Q6IA86" ,"O95163" ,"Q9H9T3")) %>% 
  ggplot() +
       geom_point(aes(x = Start, y = FractionID ,alpha = pepcount)) +
     coord_flip() +
  scale_color_manual(values = palette) +
  scale_x_reverse() +
  background_grid() +
  facet_wrap(experiment_name ~ Entry_name, scales = "free_y", dir = "v")



preprocess %>%
   # CPX-1080 CRD-mediated mRNA stability complex Q08211 Q00839
   # N terminal fragments together
    filter(Entry %in% c("Q96EB1", "Q0PNE2" ,"Q8TE02" ,"Q6IA86" ,"O95163" ,"Q9H9T3")) %>% 
  filter(experiment_name == "HEK_SEC2") %>% 
  ggplot() +
       geom_point(aes(x = Start, y = FractionID ,alpha = pepcount)) +
     coord_flip() +
  scale_color_manual(values = palette) +
  scale_x_reverse() +
  background_grid() +
  facet_wrap(experiment_name ~ Entry_name, scales = "free_y", dir = "v")


preprocess %>%
   # CPX-1080 CRD-mediated mRNA stability complex Q08211 Q00839
   # N terminal fragments together
    filter(Entry %in% c("Q9NRP0", "A0A024", "P04844" ,"P04843", "P61803", "P61165" ,"P0C6T2" ,"P46977")) %>% 
  ggplot() +
       geom_point(aes(x = Start, y = FractionID ,alpha = pepcount)) +
     coord_flip() +
  scale_color_manual(values = palette) +
  scale_x_reverse() +
  background_grid() +
  facet_wrap(experiment_name ~ Entry_name, scales = "free_y", dir = "v")

```



## Figure 7
#### Figure for g3bp1 interactions


```{r}

# removing all HEKR_IEX1, failed RNAse treatment
experiment_list <- c("HEK_IEX1") # , "HEKR_IEX1") 
g3bp1_solo <- short_tidy_unique %>% 
  filter(grepl("G3BP1", ProteinID)) %>% 
  filter(experiment_name %in% experiment_list) %>%
  b_w_plot() +
  theme_nothing() +
  theme(panel.background = element_rect(fill = "#FFFFC6"),
        panel.spacing = unit(0.25, "lines"),
        plot.margin = unit(margin(0.5,0.5,0.5,0.5), "lines")) 



  
g3bp1_solo %>%
  ggsave("figures/g3bp1_solo.png", ., width = 2, height = 1.5)

g3bp1_solo %>%
  ggsave("figures/g3bp1_solo.pdf", ., width = 2, height = 1.5)


droplet_prots <- tibble(ProteinID = c(
  "sp|Q13283|G3BP1_HUMAN_nterm",
"sp|Q13283|G3BP1_HUMAN_cterm",
"sp|Q99700|ATX2_HUMAN",
"sp|Q8WWM7|ATX2L_HUMAN",
#"sp|P30613|KPYR_HUMAN",	
"sp|P26196|DDX6_HUMAN",	
"sp|Q96F86|EDC3_HUMAN",	
"sp|Q14694|UBP10_HUMAN",	
"sp|Q14444|CAPR1_HUMAN"),

genenames = c("G3BP1_nterm",
           "G3BP1_cterm",
"ATAXIN-2",
"ATAXIN2-like",
#"KPYR",	
"DDX6",	
"EDC3",	
"UBP10",	
"CAPRIN1"))



# The HEK IEX RNAse are technical replicates, but we're not using the IEX RNASE experiment

g3bp1 <- short_tidy_unique %>% 
  filter(grepl("G3BP1", ProteinID)) %>% 
  filter(experiment_name %in% experiment_list) %>%
  b_w_plot() +
  #theme_nothing() +
  theme(panel.background = element_rect(fill = "#FFFFC6"),
        panel.spacing = unit(0.25, "lines"),
        plot.margin = unit(margin(0.5,0.5,0.5,0.5), "lines"))

g3bp1_terms <-short_tidy_unique %>%
  filter(ProteinID == "sp|Q13283|G3BP1_HUMAN") %>%
  mutate(terminus = case_when(Start >= 321 ~ "cterm",
                              TRUE ~ "nterm")) %>%
  mutate(ProteinID = paste0(ProteinID, "_", terminus)) %>%
  select(-terminus)

drops <- short_tidy_unique  %>%
  filter(ProteinID %in% droplet_prots$ProteinID) %>%
    bind_rows(g3bp1_terms ) %>%

  filter(experiment_name %in% experiment_list) %>%

  
  group_by(ProteinID, ExperimentID, experiment_order, experiment_name, FractionOrder) %>%
    summarize(tot_count = sum(pepcount)) %>%
  ungroup %>%
  group_by(ProteinID, experiment_name) %>%
     mutate(norm_tot_count = tot_count/max(tot_count)) %>%
  ungroup %>%
    left_join(droplet_prots, by = "ProteinID") %>%
  
  ggplot(aes(x = FractionOrder, y = fct_rev(fct_relevel(genenames, droplet_prots$genenames)), fill = norm_tot_count)) + 
    geom_tile() + 
    scale_fill_gradient(low = "#FFFFC6", high = "darkorange", na.value = '#FFFFC6' ) +
    #scale_fill_gradient(low = "yellow", high = "", na.value = "yellow")
    scale_x_continuous(limits = c(0, NA),breaks = seq(0, 1000, 30) ) +
  facet_wrap(~experiment_name) +
  theme(#panel.background = element_rect(fill = "#FFFFC6"),
        panel.spacing = unit(0.25, "lines"),
        plot.margin = unit(margin(0.5,0.5,0.5,0.5), "lines"), legend.position = "none",
        axis.title.y = element_blank(),
        axis.title.x= element_blank(),
        strip.text = element_blank(), strip.background = element_blank())#,
        #panel.border = element_rect(color = "grey50")) 
  
drops %>%
  ggsave("figures/droplet_elut.png", ., width = 2, height = 1.5)

drops %>%
  ggsave("figures/droplet_elut.pdf", ., width = 2, height = 1.5)


```

cdc73 test
```{r}
cdc73_prots <- tibble(ProteinID = c(
"sp|Q6P1J9|CDC73_HUMAN",

"sp|Q8N7H5|PAF1_HUMAN",

"sp|Q6PD62|CTR9_HUMAN",	
"sp|Q8WVC0|LEO1_HUMAN",	
"sp|Q92541|RTF1_HUMAN",	
"sp|Q9GZS3|WDR61_HUMAN"), 
genenames = c(
  "CDC73",
  "PAF1",
"CTR9",

"LEO1",	
"RTF1",	
"WDR61"))



cdc73_prots

 short_tidy_unique  %>%
  filter(ProteinID %in% cdc73_prots$ProteinID) %>%
    #bind_rows(g3bp1_terms ) %>%

  filter(experiment_name %in% c("HEK_IEX1")) %>%

  
  group_by(ProteinID, ExperimentID, experiment_order, experiment_name, FractionOrder) %>%
    summarize(tot_count = sum(pepcount)) %>%
  ungroup %>%
  group_by(ProteinID, experiment_name) %>%
     mutate(norm_tot_count = tot_count/max(tot_count)) %>%
  ungroup %>%
    left_join(cdc73_prots, by = "ProteinID") %>%
  
  ggplot(aes(x = FractionOrder, y = fct_rev(fct_relevel(genenames, cdc73_prots$genenames)), fill = norm_tot_count)) + 
    geom_tile() + 
    scale_fill_gradient(low = "#FFFFC6", high = "darkorange", na.value = '#FFFFC6' ) +
    #scale_fill_gradient(low = "yellow", high = "", na.value = "yellow")
    scale_x_continuous(limits = c(0, NA),breaks = seq(0, 1000, 30) ) +
  facet_wrap(~experiment_name) +
  theme(#panel.background = element_rect(fill = "#FFFFC6"),
        panel.spacing = unit(0.25, "lines"),
        plot.margin = unit(margin(0.5,0.5,0.5,0.5), "lines"), legend.position = "none",
        axis.title.y = element_blank(),
        axis.title.x= element_blank(),
        strip.text = element_blank(), strip.background = element_blank())#,
        #panel.border = element_rect(color = "grey50")) 


```






## Good to here



### Modify annotation for later plotting
```{r}
domaindis_annot <- domaindis_setup %>%
   mutate(Annotation = case_when(Annotation == "" & set == "Disordered" ~ "Disordered",
                                 Annotation == "" & set == "Transmembrane" ~ "Transmembrane",
                                TRUE ~ Annotation)) %>%
  mutate(domain_id = paste(ProtBegin, ProtEnd, Annotation, sep = "_")) %>%
  select(Entry, ProtBegin, ProtEnd, Annotation, domain_id, seqlen ) 
```





```{r}

bps_identified  %>%
 filter(grepl("A0A2K3D371_CHLRE", ProteinID))  %>%
  View()

bps_identified %>%
   filter(grepl("EMAL4_HUMAN", ProteinID))  %>% # Disordered on c term
 # filter(experiment_name == "HEK_SEC1") %>%
  View()
bps_identified_annot<- bps_identified %>%
  arrange(desc(abs(fc))) %>%
  select(ProteinID, peak, experiment_name, actual_terminal_peptide, fc, log2fc, abs_log2fc, terminal)


short_sel_peaks %>%
  filter(grepl("AFAD_HUMAN", ProteinID)) %>% 
  inner_join(bps_identified_annot) %>% 
  group_by(ProteinID, peak, experiment_name) %>%
  mutate(in_frag = case_when(
      terminal == "nterm" & Start <= actual_terminal_peptide ~ "In fragment",
      terminal == "cterm" & Start >= actual_terminal_peptide ~ "In fragment",
      TRUE ~ "Not in fragment"
  )) %>% 

  ggplot() +
       geom_point(aes(x = Start, y = FractionID, color = as.factor(peak), alpha = pepcount)) +
       geom_vline(aes(xintercept = actual_terminal_peptide, alpha = abs_log2fc, shape = in_frag, color = as.factor(peak))) + 
  facet_wrap(experiment_name ~ peak, scales = "free_y")


```

Checking
```{r}

bps %>%
 filter(grepl("VILI4_ARATH", ProteinID)) %>% 
  ggplot(aes(x = bp_start, y = fc)) +
  geom_point()+
  facet_wrap(experiment_name ~ peak + terminal)


bps_identified %>%
 filter(grepl("VILI4_ARATH", ProteinID))




long_sel_peaks %>% 
    #filter(grepl("VILI4_ARATH", ProteinID)) %>% 
  #  filter(grepl("DNMT1_HUMAN", ProteinID)) %>%
    #filter(grepl("TPR_HUMAN", ProteinID)) %>%
    #filter(grepl("A0A2K3D5H8", ProteinID)) %>%
    # filter(grepl("AFAD_HUMAN", ProteinID)) %>%
  #filter(grepl("EMAL4_HUMAN", ProteinID)) %>%
 # filter(grepl("Q9S841", ProteinID)) %>%
   #filter(grepl("HNRPU_HUMAN", ProteinID)) %>%
     #filter(grepl("A0A2K3DD86", ProteinID)) %>%
     #filter(grepl("ERLN1_HUMAN", ProteinID)) %>%  
  
  #filter(grepl("NISCH_HUMAN", ProteinID)) %>% # N term corresponds to splice variants.C term doesn't
   # filter(grepl("G3BP1_HUMAN", ProteinID)) %>%
    #       filter(grepl("A0A2K3D371_CHLRE", ProteinID)) %>%
 
  
    left_join(bps_identified_annot) %>% 
  
   #filter(grepl("Y4554_ARATH", ProteinID)) %>% 
  ggplot() +
       geom_point(aes(x = Start, y = FractionID, color = as.factor(peak), alpha = pepcount)) +
       geom_vline(aes(xintercept = actual_terminal_peptide, alpha = abs_log2fc, color = as.factor(peak))) + 
  facet_wrap(~experiment_name, scales = "free_y")

# This is double checked
# If it's negative ( c terminal fragment ), the start is the next observed peptide toward C
# If it's positive ( n terminal fragment ), the start is the next observed peptide toward N
 
```

Do precision recall of max value per experiment

Remove if fragment doesn't contain at least three peptides = reasonable

KEEP Figure 2B



# Figure 2B

```{r}

scored_labeled <- bps_identified %>%    


  group_by(ProteinID, experiment_name) %>%
   filter(abs_log2fc == max(abs_log2fc)) %>%
   rename(max_abs_log2fc=abs_log2fc) %>%
  select(ProteinID, experiment_name, actual_terminal_peptide, max_abs_log2fc, terminal) %>%
    
  
    #summarize(max_abs_log2fc = max(abs_log2fc)) %>%
  #ungroup %>%
  arrange(desc(max_abs_log2fc)) %>%
   full_join(labels) %>%
 #filter(!is.na(label)) %>% 
    filter(experiment_name != "HEKB_SEC1") %>%
  mutate(max_abs_log2fc = replace_na(max_abs_log2fc, -1))  # Add peak to show unscored 

scored_labeled %>%
  filter(label == "pos" & set == "train") %>%
  filter(max_abs_log2fc == -1)



score_dist_plot <- scored_labeled %>%
  
  mutate(custom_label = case_when(label == "neg" & set == "train" ~ "Negative train",
                           label == "pos" & set == "train" ~ "Positive train",
                           label == "neg" & set == "val" ~ "Negative validate",
                           label == "pos" & set == "val" ~ "Positive validate"
                           
                           )) %>%
  
  filter(!is.na(custom_label)) %>%
  mutate(custom_label = case_when(label=="pos" ~ "Hand selected truncated proteins",
                                  label == "neg" ~ "Random proteins")) %>%
  #mutate(custom_label = fct_relevel(custom_label, c("Positive train", "Positive validate", "Negative train","Negative validate" ))) %>%
  ggplot(aes(x = max_abs_log2fc, fill = custom_label)) + 
  geom_histogram(bins = 50) + 
  background_grid(major = ("x")) +
  scale_fill_manual(values= c(palette[2], "grey")) +
  #xlab("Proteoform score") + 
 # xlab("Max absolute log2 Fold Change\n(N vs. C terminal observed/observable peptides") +
  xlab("Max terminal bias") +
  ylab("# of proteins") +
  theme(legend.position = "none", strip.background = element_blank()) +
  facet_wrap(~custom_label,scales= "free_y", ncol = 1)

score_dist_plot

score_dist_plot %>% ggsave("figures/score_dist_plot.png", .,device = "png", width = 2.5, height = 2.5,  units = "in")
score_dist_plot %>% ggsave("figures/score_dist_plot.pdf", .,device = "pdf", width = 2.5, height = 2.5,  units = "in")


```


# Figure 2C
```{r}
positives_annot <- positives %>%
  select(ProteinID, experiment_name) %>%
  unique() %>%
  mutate(label = "Hand selected")

bps_screened <- bps_identified %>%
  filter(abs_log2fc >= 3)
  

fragment_data_terminal_expand <-
  fragment_data_terminal %>%
  separate_rows(exps, sep = ", ") %>%
  rename(experiment_name = exps)

fragment_data_score <- fragment_data_terminal_expand  %>%
  filter(term %in% c("cterm", "nterm")) %>%
  select(ProteinID, experiment_name) %>%
  inner_join(bps_screened) %>%
  anti_join(positives_annot) %>%
  mutate(label = "Found with score")

fragment_data_eye <- fragment_data_terminal_expand  %>%
  filter(term %in% c("cterm", "nterm")) %>%
  select(ProteinID, experiment_name) %>%
  anti_join(bps_screened)%>%
  anti_join(positives_annot)%>%
  mutate(label = "Final check")


fragment_data_terminal_annot <- 
  bind_rows(
    positives_annot,
    fragment_data_score,
    fragment_data_eye
  )




num_unique <-short_tidy_unique %>%
  select(ProteinID, Peptide, experiment_name) %>%
  unique %>%
  group_by(ProteinID, experiment_name) %>%
    summarise(num_unique = n()) %>%
  ungroup()

peptide_stats <- short_tidy_unique %>%

  group_by(ProteinID, experiment_name)  %>%
    summarize(num_counts = sum(pepcount)) %>% 
  ungroup() %>%
  inner_join(num_unique) %>%
  filter(num_counts > 2) %>%
  left_join(fragment_data_terminal_annot, by = c("ProteinID", "experiment_name")) %>%
  mutate(label = replace_na(label, "non_fragment"))


library(ggnewscale)
peptide_stats_plot <-   ggplot() + 
  #geom_point_rast(data = peptide_stats, aes(x = num_unique, y = num_counts), color = "grey80", alpha = 0.2) +

   geom_point(data = filter(peptide_stats, label != "non_fragment"),  
                aes(x = num_unique, y = num_counts, color = fct_rev(label),  label = paste0(ProteinID, experiment_name)), alpha = 1, size = 0.5  ) +   
   # scale_color_manual(values = c(palette[2], palette[1], palette[0]), name = "Fragment")  +
  scale_color_manual(values = c(palette[1], "#ff6200" , "#ffb001" ), name = "Fragment") +
  
   new_scale_color() +
    geom_density_2d(data = peptide_stats, aes(x = num_unique, y = num_counts, color = as.factor(..level..)), alpha = 0.8, n = 128, bins = 4, contour_var = "density", ) +
  #scale_color_brewer(palette = "Greys", guide = "none") + 
  scale_color_manual(values = c("grey70", "grey50", "grey30"), guide = "none") +
  scale_y_log10() +
  scale_x_log10() +
  ylab("# Peptide spectral matches") +
  xlab("# Unique peptides")

peptide_stats_plot

peptide_stats_plot %>% ggsave("figures/peptide_stats_plot.png", .,device = "png", width = 3.5, height = 2.2,  units = "in")

peptide_stats_plot  %>% ggsave("figures/peptide_stats_plot.pdf", ., device = "pdf", width = 3.5, height = 2.2, units = "in")

#peptide_stats_plot %>% ggsave("figures/peptide_stats_plot.png", .,device = "png", width = 3.5, height = 2,  units = "in")

#peptide_stats_plot  %>% ggsave("figures/peptide_stats_plot.pdf", ., device = "pdf", width = 3.5, height = 2, units = "in")
  


```



Observation of these disordered termini generally requires specific terminal tags, as they tend to not 
be recognized by antibodies (IF4B, fibrocystin). 

# Figure 2D
```{r}
short_tidy_unique %>% select(experiment_name) %>%
  unique

exp_totals <- short_tidy_unique%>%
  group_by(experiment_name) %>%
    summarize(exp_totpepcounts = sum(pepcount))

exp_peptides <- short_tidy_unique %>%
  select(experiment_name, Peptide) %>%
  group_by(experiment_name) %>%
    summarize(exp_totpeptides = n())

tot_positives <- 
  fragment_data_terminal_annot %>%
  unique %>%
  group_by(experiment_name) %>%
    summarize(numpos = n())

stats <- 
  tot_positives %>%
   full_join(exp_peptides, by = "experiment_name") %>%
   full_join(exp_totals, by = "experiment_name") %>%
  arrange(numpos)

#palette_OkabeIto_black <- c("#E69F00", "#56B4E9", "#009E73", "#F0E442", "#0072B2", "#D55E00", "#CC79A7", "#000000")
#colorblocks <- c("#FF0000","#0072B2","#E69F00","#009E24", "#979797","#5530AA", "#111111")
#colors_key <- c("Red", "Blue", "Orange","Green",  "Grey", "Purple","Black") 
#palette <- rep(colorblocks, 20)
library(ggrepel)

stats$numpos[is.na(stats$numpos)] <- 0

stats_plot <- stats %>%
  filter(!grepl("HEKU", experiment_name)) %>%
    filter(!grepl("HEKB", experiment_name)) %>%
    filter(!grepl("MAIZE", experiment_name)) %>% 
    filter(!grepl("SOYBN", experiment_name)) %>%

mutate(Sample = case_when(
       grepl("HEK", experiment_name) ~ "HEK",
       grepl("HEMO", experiment_name) ~ "Hemolysate",
       grepl("CHLRE", experiment_name) ~ "Chlamydomonas",
       grepl("ARATH", experiment_name) ~ "Arabidopsis"
    
  )) %>%
  mutate(Sample = fct_relevel(Sample, c("Chlamydomonas", "HEK", "Arabidopsis", "Hemolysate"))) %>%
  mutate(labels = case_when(numpos > 25 ~ experiment_name)) %>%
  
  ggplot(aes( x = exp_totpepcounts, y = numpos, color = Sample, shape = Sample, label = Sample )) + 
  geom_point(alpha = 0.9) + 
 # geom_text_repel(size = 3)+ 
  scale_color_manual(values = c("Arabidopsis" = palette[3], 
                                "Chlamydomonas" = palette[1], 
                                "HEK" = palette[2], 
                                "Hemolysate" =palette[4])) +
  scale_x_continuous(labels = scales::comma, breaks = c(400000,800000)) +
  xlab("Total PSMs") + 
  ylab("# Proteins with truncation proteoforms")

stats_plot

stats_plot %>% ggsave("figures/stats_plot.png", .,device = "png", width = 3, height = 2,  units = "in")
stats_plot %>% ggsave("figures/stats_plot.pdf", ., device = "pdf", width = 3, height = 2, units = "in")

# As peptide detection gets deeper, more proteoforms will be discoverable by this method


```



Figure 2
```{r}
left <- plot_grid(NULL, peptide_stats_plot + theme(legend.position = "bottom"), ncol= 1, labels = c("A", "C"), label_size = 8, rel_heights = c(1,0.9))
right <- plot_grid(score_dist_plot, stats_plot + theme(legend.position = "bottom"), ncol = 1, labels = c("B", "D"), label_size = 8, align = "v", axis = "l", rel_heights = c(1,0.9))

figure2_generated <- plot_grid(left, NULL, right, ncol = 3, rel_widths = c(1,0.2,1))

figure2_generated %>% ggsave("figures/figure2_generated.png", .,device = "png", width = 5, height = 5,  units = "in")
figure2_generated  %>% ggsave("figures/figure2_generated.pdf", ., device = "pdf", width = 5, height = 5, units = "in")



```



```{r}


library(caret)
make_pr_curve <- function( cutoff, for_pr,scorename =score){
  
    for_pr_classed <- for_pr %>%
      mutate(pred = case_when({{ scorename}} >= cutoff ~ 1,
                              {{ scorename}} < cutoff ~ -1)) %>%
      mutate(pred = as.factor(pred)) %>%
      mutate(num_label = as.factor(num_label))
      
     y <- for_pr_classed$num_label # factor of positive / negative cases
     predictions <- for_pr_classed$pred # factor of predictions  

     precision <- posPredValue(predictions, y, positive="1")
     recall <- sensitivity(predictions, y, positive="1")
     
     
     pr <- bind_cols(precision = precision, recall = recall) %>%
       mutate(cutoff = {{ cutoff}})
     return(pr)
}

for_pr <- scored_labeled %>%
  mutate(id = paste0(ProteinID, "-", experiment_name)) %>%
  rename(score= max_abs_log2fc) %>%
  select(id, label, set, score) %>%
  mutate(num_label = case_when(
    label == "pos" ~ 1,
    label == "neg" ~ -1
  )) 

for_pr_train <- for_pr %>%
  filter(set == "train")
for_pr_validate <- for_pr %>%
  filter(set == "val")

increments <- seq(0, max(for_pr$score), 0.1)
pr_train <- map_dfr(increments, ~make_pr_curve(., for_pr_train)) %>%
  mutate(set = "train")
pr_validate <- map_dfr(increments, ~make_pr_curve(., for_pr_validate))  %>%
  mutate(set = "validate")

pr <- bind_rows(pr_train, pr_validate)


pr_plot <- pr %>%
   ggplot() + 
  geom_line(aes(x = recall, y = precision, color = set), alpha = 0.7, size = 2) + 
  scale_color_manual(values = c("blue", "red")) +
  xlim(0,1) +
  ylim(0,1) +
  geom_label(x = 0.85, y = 0.9, label = "train", color = "blue", size = 3) +
  geom_label(x = 0.5, y = 0.7, label = "validate", color = "red", size = 3)   +
  theme(legend.position = "none")
pr_plot
  

pr_plot %>% ggsave("figures/pr_plot.png", .,device = "png", width = 2.5, height = 2.5,  units = "in")
pr_plot %>% ggsave("figures/pr_plot.pdf", .,device = "pdf", width = 2.5, height = 2.5,  units = "in")

```

FDR plot
```{r}
fdr_plot <- pr %>%
   ggplot() + 
  geom_line(aes(x = cutoff, y = precision, color = set), alpha = 0.7, size = 2) + 
  scale_color_manual(values = c("blue", "red")) +
  ylim(0,1) +
  ylab("1-FDR") +
  geom_hline(yintercept = 0.9) +
  geom_hline(yintercept = 0.5) +  
  geom_label(x = 0.85, y = 0.9, label = "train", color = "blue", size = 3) +
  geom_label(x = 0.5, y = 0.7, label = "validate", color = "red", size = 3)   +
  theme(legend.position = "none")
fdr_plot
  

fdr_plot %>% ggsave("figures/fdr_plot.png", .,device = "png", width = 2.5, height = 2.5,  units = "in")
fdr_plot %>% ggsave("figures/fdr_plot.pdf", .,device = "pdf", width = 2.5, height = 2.5,  units = "in")

```



Are fragments enriched in particular domains?
```{r}




# Graph formatting for sugiyama plot
fragment_domains_setup <- fragment_domains_auto %>%  #fragment_domains %>% 
  filter(grepl("HUMAN", ProteinID)) %>%
  select(Entry_name, Annotation ) %>%
  filter(!is.na(Annotation)) %>%
    filter(Annotation!= "nodomain") %>%
  unique() %>%
  as_tbl_graph(from = Entry_name, to = Annotation) %>%
  activate("nodes") %>%
  mutate(nodecolor_all = case_when(
       grepl("_HUMAN", name) ~ "HUMAN",
       grepl("_CHLRE", name) ~ "CHLRE",
       grepl("_ARATH", name) ~ "ARATH",
       TRUE ~ "Domain"
  )) %>%
  mutate(labelleft = case_when(
       grepl("_[HUMAN|ARATH|CHLRE]", name) ~ str_replace(name, "_HUMAN", "")
  )) %>%
    mutate(labelright = case_when(
       !grepl("_[HUMAN|ARATH|CHLRE]", name) ~ name
  )) 

fragment_domains_human_plot <- fragment_domains_setup %>%
  
  ggraph(layout = "sugiyama") +
    geom_edge_link() +
    geom_node_point(aes(color = nodecolor_all))+
  geom_node_text(aes(label = labelright), hjust = 0, nudge_y = 0.1) +
  geom_node_text(aes(label = labelleft), hjust = 1, nudge_y = -0.1) +
 # coord_flip() +
  scale_color_manual(values = c( "orange", "blue")) +
  scale_y_reverse(limits = c(3, -3)) +
  theme(axis.text.x = element_blank(),
        axis.title.x = element_blank(),
        axis.text.y = element_blank(),
        axis.title.y = element_blank(),
        legend.position = "none")
  
fragment_domains_human_plot %>% ggsave("figures/fragment_domains_human_plot.png", .,device = "png", width = 7, height = 20,  units = "in")
fragment_domains_human_plot %>% ggsave("figures/fragment_domains_human_plot.pdf", ., device = "pdf", width = 7, height = 20, units = "in")




fragment_domains_setup_multiprot <- 
  fragment_domains_auto %>%
  select(Entry_name, Annotation ) %>%
  unique() %>%
   filter(!is.na(Annotation)) %>%
    filter(Annotation!= "nodomain") %>%
  group_by(Annotation) %>%
    mutate(n = n())%>% ungroup %>%
  filter(n > 1) %>%
  as_tbl_graph(from = Entry_name, to = Annotation) %>%
  activate("nodes") %>%
  mutate(nodecolor_all = case_when(
       grepl("_HUMAN", name) ~ "HUMAN",
       grepl("_CHLRE", name) ~ "CHLRE",
       grepl("_ARATH", name) ~ "ARATH",
       TRUE ~ "Domain"
  )) %>%
  mutate(labelleft = case_when(
       grepl("_[HUMAN|ARATH|CHLRE]", name) ~ name
  )) %>%
    mutate(labelright = case_when(
       !grepl("_[HUMAN|ARATH|CHLRE]", name) ~ name
  )) 

fragment_domains_multispec_plot <- fragment_domains_setup_multiprot %>%
  
  ggraph(layout = "sugiyama") +
    geom_edge_link() +
    geom_node_point(aes(color = nodecolor_all))+
  geom_node_text(aes(label = labelright), hjust = 0, nudge_y = 0.1) +
  geom_node_text(aes(label = labelleft, color = nodecolor_all), hjust = 1, nudge_y = -0.1) +
  coord_flip() +
  scale_color_manual(values = c("orange", "darkgreen",  "black", "blue")) +
  scale_y_reverse(limits = c(4, -3)) +
  theme(axis.text.x = element_blank(),
        axis.title.x = element_blank(),
        axis.text.y = element_blank(),
        axis.title.y = element_blank(),
        legend.position = "none")
  
fragment_domains_multispec_plot %>% ggsave("figures/fragment_domains_multispec_plot.png", .,device = "png", width = 8, height = 20,  units = "in")
fragment_domains_multispec_plot %>% ggsave("figures/fragment_domains_multispec_plot.pdf", ., device = "pdf", width = 8, height = 20, units = "in")

```



Get N-fragments that end before first domain
Get C-fragments that start after last domain 

```{r}
proteins_w_full <- fragment_data %>%
  filter(term== "full") %>% select(ProteinID) %>% unique

# Not good, see INT3_HUMAN
experiments_w_full <- fragment_data %>%
  filter(term== "full") %>% select(ProteinID, experiment_name) %>% unique


fragment_data_terminal %>% filter(grepl("INT3_", ProteinID))

```


```{r}
bps_pfam <- fragment_data_terminal %>%
   filter(!is.na(loc)) %>%

  inner_join(domains_pfam, by = "Entry") %>%
      filter(!is.na(Source_ID)) %>%
  mutate(in_domain = case_when((loc >= ProtBegin & loc <= ProtEnd) ~ TRUE,
                                TRUE ~ FALSE)) %>% 
  arrange(desc(seqlen))


  
domain_plot <- bps_pfam %>%
  filter(grepl("HUMAN", ProteinID)) %>% 
  #filter(!is.na(Entry_name)) %>% 
 # mutate(Entry_name = fct_inorder(Entry_name)) %>%
  #filter(Entry_name == "DHB4_HUMAN") %>%
  filter(term %in% c("nterm", "cterm")) %>%
  ggplot() + 
    geom_rect(fill = "grey90", aes(xmin = 0, xmax = seqlen, ymin = 0, ymax = 1)) +
  geom_rect(fill = "#97b6b9", aes(xmin = ProtBegin, xmax = ProtEnd, ymin = 0, ymax = 1)) +
  geom_point(color = "red", aes(x = loc, y =0.5, shape = term), size = 2.5) +
  #geom_point(color = "red", aes(x = loc, y =0.5, shape = direction)) +
  scale_shape_manual(values = c(91,93, NA)) +
  #geom_point(shape=18, color = "red", aes(x = loc, y =0.5)) + 
  #geom_vline(color  = "black", xintercept = 0) +
   # geom_vline(color = "black", aes(xintercept = seqlen)) + 
  theme(panel.margin=unit(.05, "lines"),
        strip.text.y.left = element_text(angle = 0),
        #strip.text.y = element_text(angle = 180),
        strip.background =element_rect(fill = "white"),
       axis.text.x = element_blank(), 
        axis.ticks.x = element_blank(),
       axis.text.y = element_blank(),
       axis.ticks.y = element_blank(),
       axis.line.x = element_blank(),
       axis.line.y = element_blank(),
       axis.title.x = element_blank(),
       axis.title.y = element_blank()
       #panel.border = element_rect(color = "black", fill = NA, size = 1)
        ) +
          facet_wrap(~fct_inorder(Entry_name), strip.position = "left",ncol = 1) 
domain_plot


domain_plot %>% ggsave("figures/domain_plot.png", .,device = "png", width = 7, height = 10,  units = "in")
domain_plot %>% ggsave("figures/domain_plot.pdf", ., device = "pdf", width = 7, height = 10, units = "in")
```

```{r}
domains_pfam %>%

      filter(!is.na(Source_ID)) %>%
  filter(Entry %in% fragment_data_terminal$Entry) %>%
  rowwise %>%
  mutate(domlength = ProtEnd - ProtBegin) %>%
  select(Entry, domlength) %>%
  group_by(Entry) %>%
     summarize(tot_dom_cov = sum(domlength)) %>%
  ungroup() %>%
  left_join(meta ) %>%
      filter(grepl("HUMAN", Entry_name)) %>%
   mutate(prop_domain = tot_dom_cov/seqlen) %>%
   summarize(x = 1- mean(prop_domain))

bps_pfam %>%

  filter(grepl("HUMAN", ProteinID)) %>% 
  select(ProteinID, peakid, term, in_domain) %>%
  filter(term %in% c("nterm", "cterm")) %>%
  unique() %>%
  group_by(in_domain) %>%
     summarize(n = n())


```

????
```{r}

domain_coverage <- bps_pfam %>%

  rowwise() %>%
  mutate(dom_length = ProtEnd-ProtBegin) %>%
  group_by(Entry_name, seqlen) %>%
    summarize(tot_dom_length = sum(dom_length)) %>%
  ungroup %>%
  rowwise() %>%
  mutate(dom_coverage = tot_dom_length/seqlen) %>%
  mutate(nondomain = 1-dom_coverage)


prod(domain_coverage$nondomain, na.rm = TRUE)

```






```{r}
bps_dis <- fragment_data_terminal %>%
  filter(!is.na(loc)) %>%
  left_join(meta) %>% #, by = "Entry") %>%
  inner_join(domains_dis, by = "Entry") %>%
  mutate(in_dis = case_when((loc >= ProtBegin & loc <= ProtEnd) ~ TRUE,
                                TRUE ~ FALSE)) %>% 
  arrange(seqlen)
  
dis_plot <- bps_dis %>%
  filter(experiment_name == "CHLRE_IEX1") %>%
  mutate(Entry_name = fct_inorder(Entry_name)) %>%
  #filter(Entry_name == "UBP15_HUMAN") %>%
  ggplot() + 
    geom_rect(fill = "grey90", aes(xmin = 0, xmax = seqlen, ymin = 0, ymax = 1)) +
  geom_rect(fill = "cadetblue4", aes(xmin = ProtBegin, xmax = ProtEnd, ymin = 0, ymax = 1)) +
  geom_point(color = "red", aes(x = loc, y =0.5, shape = term)) +
   scale_shape_manual(values = c(91,93)) +
  #geom_point(shape=18, color = "red", aes(x = loc, y =0.5)) + 
  #geom_vline(color  = "black", xintercept = 0) +
   # geom_vline(color = "black", aes(xintercept = seqlen)) + 
  theme(panel.margin=unit(.05, "lines"),
        strip.text.y.left = element_text(angle = 0),
        strip.background =element_rect(fill = "white"),
       axis.text.x = element_blank(), 
        axis.ticks.x = element_blank(),
       axis.text.y = element_blank(),
       axis.ticks.y = element_blank(),
       axis.line.x = element_blank(),
       axis.line.y = element_blank(),
       axis.title.x = element_blank(),
       panel.border = element_rect(color = "black", fill = NA, size = 1)
        ) +
           facet_wrap(~Entry_name, strip.position = "left",ncol = 2) 
dis_plot


#domain_plot %>% ggsave("figures/domain_plot.png", .,device = "png", width = 7, height = 5,  units = "in")
#domain_plot %>% ggsave("figures/domain_plot.pdf", ., device = "pdf", width = 7, height = 5, units = "in")


#Look up BTF3 and NACA
# Very important - Why no picture of NACA generated?

```





Are fragments more disordered than rest of prot?
```{r}

diso_coverage <- domains_dis  %>%
  mutate(length = ProtEnd - ProtBegin) %>%
  group_by(Entry) %>%
     summarize(totaldis = sum(length)) %>%
  ungroup %>%
  inner_join(meta) %>%
  filter(!is.na(seqlen))

# bps_dis <- fragment_data_terminal %>% ungroup %>%
#  inner_join(meta) %>%
#  filter(!is.na(seqlen)) %>%
#  mutate(fragment_start = 
#           case_when(term == "nterm" ~ 1,
#                     term == "cterm" ~ loc)) %>%
#  mutate(fragment_end = 
#           case_when(term == "nterm" ~ as.integer(loc),
#                     term == "cterm" ~ seqlen)) %>%  
#  left_join(domains_dis)
 
 
bps_dis_coverage <- bps_dis %>%
  select(ProteinID, Entry, nterm_pos,cterm_pos, ProtBegin, ProtEnd) %>%
  mutate(dis_frag_start = case_when(
    ProtBegin >= nterm_pos  & ProtBegin <= cterm_pos ~ ProtBegin,
    cterm_pos >= ProtBegin & nterm_pos <= ProtEnd ~  as.integer(nterm_pos)
    
  ))   %>%
  filter(!is.na(dis_frag_start)) %>%
  mutate(dis_frag_end = case_when(
    cterm_pos >= ProtEnd ~ ProtEnd,
    cterm_pos <= ProtEnd ~ cterm_pos
       
  )) %>%
  mutate(fragment_tot_length = cterm_pos - nterm_pos) %>%
  mutate(dis_length = dis_frag_end - dis_frag_start) %>%
    left_join(diso_coverage) %>%
  mutate(fragment_dis_cov = dis_length/fragment_tot_length,
         total_dis_cov = totaldis/seqlen) %>%
  mutate(cov_diff = fragment_dis_cov/ total_dis_cov) 
  
bps_dis_coverage %>%
  ggplot(aes(x = total_dis_cov, y = fragment_dis_cov, size = cov_diff, label = ProteinID)) + 
  geom_point()
  
```

Get length of each disordered terminal. Each protein has up to two disordered terminal
Compare to protein abundance as well
```{r}


per_prot_abundance <- long_sel %>%
  filter(experiment_name != "HEKB_SEC1") %>%
  group_by(ProteinID) %>%
     summarize(tot = sum(pepcount)) %>% ungroup %>%
  separate(ProteinID, into = c(NA, "Entry", NA), sep = "[|]")
  
all_disordered_termini <- domains_dis %>% left_join(meta, by = "Entry") %>%
  filter(ProtBegin ==1 |  ProtEnd == seqlen) %>%
  mutate(dis_length = ProtEnd - ProtBegin) %>%
  select(Entry, dis_length) %>%
  mutate(set = "all disordered termini") 

fragment_disordered_termini <-bps_dis_coverage %>%
  filter(dis_frag_start ==1 | dis_frag_end == seqlen) %>%
  select(Entry, dis_length) %>%
  mutate(set = "fragment disordered_termini")

both_disordered_termini <- bind_rows(
  all_disordered_termini, 
  fragment_disordered_termini
) %>%
 
  left_join(per_prot_abundance, by = "Entry")


both_disordered_termini %>%
  
  ggplot(aes(x = tot, fill = set)) +
    geom_histogram(position = "dodge") + 
  #facet_wrap(~set,  ncol = 1) +
  scale_x_log10() +
  scale_y_log10(expand = c(0,0))
  
  
#    ggplot(aes(x = tot, y = fragment_dis_length, size = fragment_dis_cov)) +
#  geom_point() +
#  scale_x_log10()

bps_loc %>% ungroup %>%
  select(ProteinID, Entry) %>%
  left_join(meta) %>% View()
```





